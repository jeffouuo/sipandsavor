# 用戶刪除功能使用指南

## 功能概述

管理員現在可以在後台管理系統中刪除用戶帳號。此功能包含雙重確認機制，確保不會誤刪重要帳號。

## 主要功能

### 1. 刪除用戶
- **位置**: 管理後台 → 用戶管理
- **權限**: 僅限管理員
- **安全措施**: 雙重確認 + 用戶名驗證

### 2. 安全機制

#### 防止誤刪
- ✅ 第一次確認：詢問是否確定刪除
- ✅ 第二次確認：要求輸入用戶名驗證
- ✅ 防止自刪：管理員無法刪除自己的帳號

#### 自動更新
- ✅ 刪除後自動刷新用戶列表
- ✅ 刪除後自動更新統計數據
- ✅ 清除相關緩存

## 使用步驟

### 步驟 1: 進入用戶管理
```
1. 登入管理後台
2. 點擊頂部導航的「用戶管理」標籤
3. 找到要刪除的用戶
```

### 步驟 2: 點擊刪除按鈕
```
在用戶列表的操作欄中：
- 「禁用」按鈕：臨時禁用帳號（可恢復）
- 「刪除」按鈕：永久刪除帳號（不可恢復）
```

### 步驟 3: 第一次確認
```
系統會彈出確認對話框：
「⚠️ 警告：您確定要刪除用戶「xxx」嗎？

此操作無法撤銷！」

- 點擊「確定」繼續
- 點擊「取消」中止操作
```

### 步驟 4: 第二次確認（輸入用戶名）
```
系統要求輸入用戶名以確認刪除：
「請輸入用戶名「xxx」以確認刪除：」

必須完全匹配用戶名（包括大小寫）才能刪除
- 輸入正確用戶名 → 執行刪除
- 輸入錯誤 → 顯示「用戶名不匹配，刪除已取消」
- 點擊「取消」→ 中止操作
```

### 步驟 5: 刪除完成
```
成功刪除後：
✅ 顯示「用戶刪除成功」提示
✅ 自動刷新用戶列表
✅ 更新總用戶數統計
```

## 使用示例

### 示例 1: 刪除測試帳號
```
場景：刪除用戶名為 "test_user" 的測試帳號

步驟：
1. 在用戶列表中找到 "test_user"
2. 點擊該用戶的「刪除」按鈕
3. 第一次確認：點擊「確定」
4. 第二次確認：輸入 "test_user"（必須完全匹配）
5. 點擊「確定」完成刪除
```

### 示例 2: 取消刪除操作
```
場景：誤點了刪除按鈕

方法 1：第一次確認時點擊「取消」
方法 2：第二次確認時點擊「取消」
方法 3：第二次確認時輸入錯誤的用戶名
```

## 安全提示

### ⚠️ 重要警告

1. **刪除操作不可撤銷**
   - 用戶數據會永久從數據庫中刪除
   - 無法恢復已刪除的用戶資料
   - 建議先禁用而不是刪除

2. **無法刪除自己**
   - 管理員無法刪除自己的帳號
   - 防止意外鎖定自己
   - 如需刪除管理員帳號，請由其他管理員操作

3. **刪除前請確認**
   - 確認要刪除的用戶是正確的
   - 檢查用戶是否有重要數據
   - 考慮是否只需要禁用而非刪除

### 💡 最佳實踐

1. **優先使用禁用功能**
   ```
   - 臨時帳號問題 → 使用「禁用」
   - 違規用戶 → 使用「禁用」
   - 需要保留歷史記錄 → 使用「禁用」
   - 確定不再需要 → 使用「刪除」
   ```

2. **定期清理**
   ```
   - 定期檢查禁用的帳號
   - 確認哪些帳號可以安全刪除
   - 保留重要用戶的歷史數據
   ```

3. **備份重要數據**
   ```
   - 刪除前導出重要數據
   - 定期備份用戶數據庫
   - 保留刪除記錄日誌
   ```

## API 接口

### 後端 API

**路由**: `DELETE /api/users/admin/:id`

**權限**: 僅限管理員

**請求**:
```bash
DELETE /api/users/admin/USER_ID
Headers: {
  "Authorization": "Bearer ADMIN_TOKEN"
}
```

**成功回應**:
```json
{
  "success": true,
  "message": "用戶刪除成功"
}
```

**錯誤回應**:

1. 用戶不存在
```json
{
  "success": false,
  "message": "用戶不存在"
}
```

2. 嘗試刪除自己
```json
{
  "success": false,
  "message": "不能刪除自己的帳戶"
}
```

3. 服務器錯誤
```json
{
  "success": false,
  "message": "刪除用戶失敗"
}
```

## 前端實現

### JavaScript 函數
```javascript
async function deleteUser(userId, username) {
    // 第一次確認
    if (!confirm(`⚠️ 警告：您確定要刪除用戶「${username}」嗎？\n\n此操作無法撤銷！`)) {
        return;
    }
    
    // 第二次確認（輸入用戶名）
    const confirmText = prompt(`請輸入用戶名「${username}」以確認刪除：`);
    if (confirmText !== username) {
        if (confirmText !== null) {
            showAlert('用戶名不匹配，刪除已取消', 'error');
        }
        return;
    }

    try {
        const token = localStorage.getItem('adminToken');
        
        const response = await fetch(`${API_BASE_URL}/users/admin/${userId}`, {
            method: 'DELETE',
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });

        const data = await response.json();

        if (!response.ok) {
            throw new Error(data.message || '刪除用戶失敗');
        }

        showAlert('用戶刪除成功', 'success');
        
        // 刷新列表和統計
        await Promise.all([
            loadUsers(currentPage.users),
            loadStats(true)
        ]);

    } catch (error) {
        showAlert(error.message || '刪除用戶失敗', 'error');
    }
}
```

## 測試功能

### 使用測試腳本
```bash
# 測試刪除功能
node test-delete-user.js
```

測試腳本會：
1. 創建測試用戶
2. 驗證用戶存在
3. 刪除用戶
4. 驗證用戶已被刪除

## 常見問題 FAQ

**Q1: 刪除用戶後可以恢復嗎？**
A: 不可以。刪除操作會永久從數據庫中移除用戶數據，無法恢復。建議先使用「禁用」功能。

**Q2: 可以批量刪除用戶嗎？**
A: 目前只支持單個刪除。如需批量刪除，請重複操作或使用腳本。

**Q3: 刪除用戶會影響其訂單嗎？**
A: 用戶的歷史訂單不會被刪除，但會失去與用戶的關聯。建議謹慎刪除有訂單的用戶。

**Q4: 為什麼需要輸入用戶名確認？**
A: 這是為了防止誤刪重要帳號。雙重確認機制可以有效減少操作失誤。

**Q5: 可以刪除管理員帳號嗎？**
A: 可以刪除其他管理員帳號，但無法刪除自己的帳號。

**Q6: 刪除和禁用有什麼區別？**
A: 
- **禁用**：帳號仍在數據庫中，只是無法登入，可以隨時恢復
- **刪除**：永久從數據庫中移除，無法恢復

**Q7: 刪除失敗怎麼辦？**
A: 檢查：
1. 是否有管理員權限
2. 網絡連接是否正常
3. 是否嘗試刪除自己的帳號
4. 查看瀏覽器控制台錯誤信息

## 功能對比

| 功能 | 禁用 | 刪除 |
|------|------|------|
| 可恢復 | ✅ 是 | ❌ 否 |
| 數據保留 | ✅ 完整保留 | ❌ 永久刪除 |
| 用戶登入 | ❌ 無法登入 | ❌ 無法登入 |
| 歷史訂單 | ✅ 保留 | ⚠️ 失去關聯 |
| 統計數據 | ✅ 計入 | ❌ 不計入 |
| 操作難度 | 簡單（一次確認） | 複雜（雙重確認） |
| 建議用途 | 臨時處理 | 永久清理 |

## 更新日誌

### v1.0.0 (2025-10-13)
- ✅ 新增用戶刪除功能
- ✅ 實現雙重確認機制
- ✅ 添加用戶名驗證
- ✅ 防止刪除自己的帳號
- ✅ 刪除後自動更新統計

---

**版本**: 1.0.0  
**更新日期**: 2025年10月13日  
**作者**: Sip and Savor 開發團隊



