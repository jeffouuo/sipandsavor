<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¨‚å–®å®Œæˆ - é£²èŒ¶è¶£</title>
    <link rel="icon" type="image/webp" href="/images/sipandsavor.webp">
    <link rel="shortcut icon" type="image/webp" href="/images/sipandsavor.webp">
    <link rel="stylesheet" href="style-optimized.css">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <style>
        .result-container {
            max-width: 500px;
            margin: 100px auto;
            padding: 40px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .result-icon {
            font-size: 80px;
            margin-bottom: 20px;
        }

        .success-icon {
            color: #2ed573;
        }

        .failed-icon {
            color: #e74c3c;
        }

        .error-icon {
            color: #f39c12;
        }

        .result-title {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 20px;
            color: #2c3e50;
        }

        .result-message {
            font-size: 16px;
            color: #666;
            margin-bottom: 30px;
            line-height: 1.6;
        }

        .order-info {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: left;
        }

        .order-info-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding: 8px 0;
            border-bottom: 1px solid #e9ecef;
        }

        .order-info-item:last-child {
            border-bottom: none;
        }

        .order-info-label {
            font-weight: bold;
            color: #2c3e50;
        }

        .order-info-value {
            color: #666;
        }

        .btn-group {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-block;
        }

        .btn-primary {
            background: #2ed573;
            color: white;
        }

        .btn-primary:hover {
            background: #26c463;
        }

        .btn-secondary {
            background: #95a5a6;
            color: white;
        }

        .btn-secondary:hover {
            background: #7f8c8d;
        }

        /* Loading å‹•ç•« */
        .loading-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px;
        }

        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #2ed573;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            color: #2c3e50;
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .loading-subtext {
            color: #666;
            font-size: 14px;
        }

        .countdown {
            color: #2ed573;
            font-weight: bold;
            font-size: 16px;
            margin-top: 20px;
        }

        /* Toast é€šçŸ¥ */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #2ed573;
            color: white;
            padding: 15px 25px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 10000;
            animation: slideIn 0.3s ease-out;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .toast-icon {
            font-size: 24px;
        }
    </style>
</head>
<body>
    <div class="result-container">
        <div id="resultContent">
            <!-- å…§å®¹å°‡ç”± JavaScript å‹•æ…‹ç”Ÿæˆ -->
        </div>
    </div>

    <script>
        // ============================================
        // è¨‚å–®å®Œæˆé é¢ - ä¸­è½‰è™•ç†é‚è¼¯
        // ============================================

        // 1. åƒæ•¸è®€å–èˆ‡é©—è­‰
        const urlParams = new URLSearchParams(window.location.search);
        const status = urlParams.get('status');
        const orderNo = urlParams.get('orderNo');
        const amount = urlParams.get('amount');
        const message = urlParams.get('message');

        console.log('ğŸ“¥ è¨‚å–®å®Œæˆé é¢è¼‰å…¥:', { status, orderNo, amount, message });

        // é©—è­‰ status
        if (status !== 'success') {
            console.warn('âš ï¸ è¨‚å–®ç‹€æ…‹ä¸æ˜¯æˆåŠŸï¼Œé¡¯ç¤ºéŒ¯èª¤è¨Šæ¯');
            showErrorState();
            return;
        }

        // 2. åŸ·è¡Œè¨‚å–®å®Œæˆé‚è¼¯ï¼ˆé¡ä¼¼ useEffectï¼‰
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸ”„ é–‹å§‹åŸ·è¡Œè¨‚å–®å®Œæˆé‚è¼¯...');
            
            // é¡¯ç¤º Loading å‹•ç•«
            showLoadingState();
            
            // é¡¯ç¤º Toast é€šçŸ¥
            showToast('ä»˜æ¬¾æˆåŠŸï¼æ­£åœ¨ç‚ºæ‚¨è™•ç†...');

            // åŸ·è¡Œè¨‚å–®å®Œæˆé‚è¼¯
            processOrderCompletion();
        });

        /**
         * è™•ç†è¨‚å–®å®Œæˆé‚è¼¯
         */
        async function processOrderCompletion() {
            try {
                // æ­¥é©Ÿ 1: æ¸…ç©ºè³¼ç‰©è»Š
                console.log('ğŸ›’ æ­¥é©Ÿ 1: æ¸…ç©ºè³¼ç‰©è»Š...');
                clearCart();
                
                // æ­¥é©Ÿ 2: (å¯é¸) å‘¼å«å¾Œç«¯ API ç¢ºèªè¨‚å–®ç‹€æ…‹
                if (orderNo) {
                    console.log('ğŸ” æ­¥é©Ÿ 2: ç¢ºèªè¨‚å–®ç‹€æ…‹...');
                    await verifyOrderStatus(orderNo);
                }

                // æ­¥é©Ÿ 3: é¡¯ç¤ºæˆåŠŸè¨Šæ¯
                console.log('âœ… æ­¥é©Ÿ 3: é¡¯ç¤ºæˆåŠŸè¨Šæ¯...');
                showSuccessState();

                // æ­¥é©Ÿ 4: 3ç§’å¾Œè‡ªå‹•å°èˆªåˆ°é¦–é 
                console.log('â±ï¸ æ­¥é©Ÿ 4: 3ç§’å¾Œè‡ªå‹•å°èˆª...');
                startCountdown(3, () => {
                    console.log('ğŸš€ è‡ªå‹•å°èˆªåˆ°é¦–é ');
                    window.location.href = '/';
                });

            } catch (error) {
                console.error('âŒ è™•ç†è¨‚å–®å®Œæˆæ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                showErrorState('è™•ç†è¨‚å–®æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹è¯ç¹«å®¢æœ');
            }
        }

        /**
         * æ¸…ç©ºè³¼ç‰©è»Š
         */
        function clearCart() {
            try {
                // æ¸…é™¤ localStorage ä¸­çš„è³¼ç‰©è»Š
                localStorage.removeItem('cart');
                localStorage.removeItem('pendingOrder');
                
                // æ¸…é™¤å…¨å±€è®Šé‡ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                if (typeof window.cart !== 'undefined') {
                    window.cart = [];
                }
                
                console.log('âœ… è³¼ç‰©è»Šå·²æ¸…é™¤');
            } catch (error) {
                console.error('âŒ æ¸…é™¤è³¼ç‰©è»Šå¤±æ•—:', error);
                throw error;
            }
        }

        /**
         * ç¢ºèªè¨‚å–®ç‹€æ…‹ï¼ˆDouble Checkï¼‰
         */
        async function verifyOrderStatus(orderNo) {
            try {
                // é€™è£¡å¯ä»¥å‘¼å«å¾Œç«¯ API ç¢ºèªè¨‚å–®ç‹€æ…‹
                // ä¾‹å¦‚: const response = await fetch(`/api/orders/${orderNo}/verify`);
                // ç›®å‰å…ˆè·³éï¼Œå› ç‚ºç¶ ç•Œå·²ç¶“é©—è­‰éäº†
                console.log('âœ… è¨‚å–®ç‹€æ…‹ç¢ºèªå®Œæˆï¼ˆä½¿ç”¨ç¶ ç•Œé©—è­‰çµæœï¼‰');
                return true;
            } catch (error) {
                console.warn('âš ï¸ è¨‚å–®ç‹€æ…‹ç¢ºèªå¤±æ•—ï¼ˆéé—œéµéŒ¯èª¤ï¼‰:', error);
                // ä¸æ‹‹å‡ºéŒ¯èª¤ï¼Œå› ç‚ºé€™ä¸æ˜¯é—œéµæ­¥é©Ÿ
                return false;
            }
        }

        /**
         * é¡¯ç¤º Loading ç‹€æ…‹
         */
        function showLoadingState() {
            const resultContent = document.getElementById('resultContent');
            resultContent.innerHTML = `
                <div class="loading-container">
                    <div class="loading-spinner"></div>
                    <div class="loading-text">ä»˜æ¬¾æˆåŠŸï¼</div>
                    <div class="loading-subtext">æ­£åœ¨ç‚ºæ‚¨è™•ç†è¨‚å–®...</div>
                </div>
            `;
        }

        /**
         * é¡¯ç¤ºæˆåŠŸç‹€æ…‹
         */
        function showSuccessState() {
            const resultContent = document.getElementById('resultContent');
            resultContent.innerHTML = `
                <div class="result-icon success-icon">
                    <span class="material-icons">check_circle</span>
                </div>
                <h1 class="result-title">è¨‚å–®å®Œæˆï¼</h1>
                <p class="result-message">æ„Ÿè¬æ‚¨çš„è³¼è²·ï¼Œè¨‚å–®å·²æˆåŠŸè™•ç†ã€‚</p>
                ${orderNo || amount ? `
                    <div class="order-info">
                        ${orderNo ? `
                            <div class="order-info-item">
                                <span class="order-info-label">è¨‚å–®ç·¨è™Ÿï¼š</span>
                                <span class="order-info-value">${orderNo}</span>
                            </div>
                        ` : ''}
                        ${amount ? `
                            <div class="order-info-item">
                                <span class="order-info-label">æ”¯ä»˜é‡‘é¡ï¼š</span>
                                <span class="order-info-value">NT$ ${parseInt(amount).toLocaleString()}</span>
                            </div>
                        ` : ''}
                    </div>
                ` : ''}
                <div class="countdown" id="countdown">3 ç§’å¾Œè‡ªå‹•è¿”å›é¦–é ...</div>
                <div class="btn-group">
                    <a href="/" class="btn btn-primary">ç«‹å³è¿”å›é¦–é </a>
                    <a href="menu.html" class="btn btn-secondary">ç¹¼çºŒè³¼ç‰©</a>
                </div>
            `;
        }

        /**
         * é¡¯ç¤ºéŒ¯èª¤ç‹€æ…‹
         */
        function showErrorState(errorMessage) {
            const resultContent = document.getElementById('resultContent');
            const displayMessage = errorMessage || message || 'ç³»çµ±ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚';
            
            resultContent.innerHTML = `
                <div class="result-icon error-icon">
                    <span class="material-icons">error</span>
                </div>
                <h1 class="result-title">ç™¼ç”ŸéŒ¯èª¤</h1>
                <p class="result-message">${displayMessage}</p>
                <div class="btn-group">
                    <a href="/" class="btn btn-primary">è¿”å›é¦–é </a>
                    <a href="menu.html" class="btn btn-secondary">è¿”å›èœå–®</a>
                </div>
            `;
        }

        /**
         * é¡¯ç¤º Toast é€šçŸ¥
         */
        function showToast(message) {
            // ç§»é™¤ç¾æœ‰çš„ Toastï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            const existingToast = document.querySelector('.toast');
            if (existingToast) {
                existingToast.remove();
            }

            // å‰µå»ºæ–°çš„ Toast
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.innerHTML = `
                <span class="material-icons toast-icon">check_circle</span>
                <span>${message}</span>
            `;
            document.body.appendChild(toast);

            // 3ç§’å¾Œè‡ªå‹•ç§»é™¤
            setTimeout(() => {
                toast.style.animation = 'slideIn 0.3s ease-out reverse';
                setTimeout(() => {
                    toast.remove();
                }, 300);
            }, 3000);
        }

        /**
         * å€’æ•¸è¨ˆæ™‚
         */
        function startCountdown(seconds, callback) {
            const countdownEl = document.getElementById('countdown');
            if (!countdownEl) {
                // å¦‚æœå€’æ•¸å…ƒç´ ä¸å­˜åœ¨ï¼Œç›´æ¥åŸ·è¡Œå›èª¿
                setTimeout(callback, seconds * 1000);
                return;
            }

            let remaining = seconds;
            countdownEl.textContent = `${remaining} ç§’å¾Œè‡ªå‹•è¿”å›é¦–é ...`;

            const interval = setInterval(() => {
                remaining--;
                if (remaining > 0) {
                    countdownEl.textContent = `${remaining} ç§’å¾Œè‡ªå‹•è¿”å›é¦–é ...`;
                } else {
                    clearInterval(interval);
                    countdownEl.textContent = 'æ­£åœ¨è·³è½‰...';
                    callback();
                }
            }, 1000);
        }
    </script>
</body>
</html>
