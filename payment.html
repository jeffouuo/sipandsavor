<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>選擇支付方式 - 飲茶趣</title>
    <link rel="icon" type="image/webp" href="/images/sipandsavor.webp">
    <link rel="shortcut icon" type="image/webp" href="/images/sipandsavor.webp">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' https:; script-src 'self' 'unsafe-inline' 'unsafe-eval' https:; style-src 'self' 'unsafe-inline' https:; font-src 'self' https:; img-src 'self' data: https:; connect-src 'self' https:; frame-src 'self' https:;">
    <link rel="stylesheet" href="style-optimized.css">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <style>
        .payment-container {
            max-width: 600px;
            margin: 100px auto;
            padding: 30px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        .payment-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .payment-header h1 {
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .order-summary {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
        }

        .order-summary h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.2em;
        }

        .order-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #e0e0e0;
        }

        .order-item:last-child {
            border-bottom: none;
        }

        .order-total {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 2px solid #2c3e50;
            font-size: 1.3em;
            font-weight: bold;
            color: #2c3e50;
        }

        .payment-methods {
            margin-bottom: 30px;
        }

        .payment-methods h3 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.2em;
        }

        .payment-option {
            display: flex;
            align-items: center;
            padding: 20px;
            margin-bottom: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
        }

        .payment-option:hover {
            border-color: #2ed573;
            background: #f0fff4;
        }

        .payment-option.selected {
            border-color: #2ed573;
            background: #e8f5e9;
        }

        .payment-option input[type="radio"] {
            margin-right: 15px;
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .payment-option label {
            flex: 1;
            cursor: pointer;
            display: flex;
            align-items: center;
            font-size: 1.1em;
            color: #2c3e50;
        }

        .payment-icon {
            font-size: 2em;
            margin-right: 15px;
            color: #2ed573;
        }

        .payment-actions {
            display: flex;
            gap: 15px;
        }

        .btn {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background-color: #2ed573;
            color: white;
        }

        .btn-primary:hover {
            background-color: #26d0ce;
        }

        .btn-secondary {
            background-color: #95a5a6;
            color: white;
        }

        .btn-secondary:hover {
            background-color: #7f8c8d;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        @media (max-width: 768px) {
            .payment-container {
                margin: 20px;
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="payment-container">
        <div class="payment-header">
            <h1>選擇支付方式</h1>
            <p>請選擇您的付款方式</p>
        </div>

        <div class="order-summary" id="orderSummary">
            <h3>訂單摘要</h3>
            <div id="orderItems"></div>
            <div class="order-total">
                <span>總計：</span>
                <span id="totalAmount">NT$ 0</span>
            </div>
        </div>

        <div class="payment-methods">
            <h3>支付方式</h3>
            <div class="payment-option" data-method="credit_card">
                <input type="radio" name="paymentMethod" id="credit_card" value="credit_card" checked>
                <label for="credit_card">
                    <span class="material-icons payment-icon">credit_card</span>
                    <span>信用卡</span>
                </label>
            </div>
            <div class="payment-option" data-method="line_pay">
                <input type="radio" name="paymentMethod" id="line_pay" value="line_pay">
                <label for="line_pay">
                    <span class="material-icons payment-icon">account_balance_wallet</span>
                    <span>LINE Pay</span>
                </label>
            </div>
            <div class="payment-option" data-method="cash">
                <input type="radio" name="paymentMethod" id="cash" value="cash">
                <label for="cash">
                    <span class="material-icons payment-icon">money</span>
                    <span>現金支付（現場付款）</span>
                </label>
            </div>
        </div>

        <div class="payment-actions">
            <button class="btn btn-secondary" onclick="goBack()">返回</button>
            <button class="btn btn-primary" id="proceedBtn" onclick="proceedToPayment()">前往支付</button>
        </div>
    </div>

    <script>
        // 從 localStorage 獲取訂單數據
        let orderData = null;

        function loadOrderData() {
            const storedData = localStorage.getItem('pendingOrder');
            if (!storedData) {
                alert('沒有找到訂單數據，將返回菜單頁面');
                window.location.href = 'menu.html';
                return;
            }

            try {
                orderData = JSON.parse(storedData);
                displayOrderSummary();
            } catch (error) {
                console.error('解析訂單數據失敗:', error);
                alert('訂單數據格式錯誤，將返回菜單頁面');
                window.location.href = 'menu.html';
            }
        }

        function displayOrderSummary() {
            if (!orderData || !orderData.items) return;

            const itemsContainer = document.getElementById('orderItems');
            const totalAmountEl = document.getElementById('totalAmount');

            itemsContainer.innerHTML = '';
            let total = 0;

            orderData.items.forEach(item => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'order-item';
                
                const subtotal = (parseFloat(item.price) || 0) * (parseInt(item.quantity) || 1);
                total += subtotal;

                itemDiv.innerHTML = `
                    <span>${item.name} x ${item.quantity}</span>
                    <span>NT$ ${subtotal.toLocaleString()}</span>
                `;
                itemsContainer.appendChild(itemDiv);
            });

            totalAmountEl.textContent = `NT$ ${total.toLocaleString()}`;
            orderData.totalAmount = total;
        }

        // 支付方式選擇
        document.querySelectorAll('.payment-option').forEach(option => {
            option.addEventListener('click', function() {
                document.querySelectorAll('.payment-option').forEach(opt => {
                    opt.classList.remove('selected');
                });
                this.classList.add('selected');
                const radio = this.querySelector('input[type="radio"]');
                if (radio) {
                    radio.checked = true;
                }
            });
        });

        // 初始化選中狀態
        document.querySelector('.payment-option[data-method="credit_card"]').classList.add('selected');

        function proceedToPayment() {
            const selectedMethod = document.querySelector('input[name="paymentMethod"]:checked');
            if (!selectedMethod) {
                alert('請選擇支付方式');
                return;
            }

            if (!orderData) {
                alert('訂單數據錯誤，請重新下單');
                window.location.href = 'menu.html';
                return;
            }

            // 更新支付方式
            orderData.paymentMethod = selectedMethod.value;

            // 如果是現金支付，直接提交訂單
            if (selectedMethod.value === 'cash') {
                submitOrder();
                return;
            }

            // 如果是信用卡支付，跳轉到綠界金流支付頁面
            if (selectedMethod.value === 'credit_card') {
                localStorage.setItem('pendingOrder', JSON.stringify(orderData));
                window.location.href = 'ecpay-payment.html';
                return;
            }

            // 其他線上支付（LINE Pay），跳轉到支付處理頁面
            localStorage.setItem('pendingOrder', JSON.stringify(orderData));
            window.location.href = `payment-process.html?method=${selectedMethod.value}`;
        }

        function submitOrder() {
            const btn = document.getElementById('proceedBtn');
            btn.disabled = true;
            btn.textContent = '處理中...';

            // 檢查是否為內用訂單
            const isDineIn = localStorage.getItem('dineInTableNumber');
            const url = isDineIn ? '/api/orders/dine-in' : '/api/orders/checkout';

            let requestData;
            if (isDineIn) {
                requestData = {
                    tableNumber: localStorage.getItem('dineInTableNumber'),
                    area: '內用區',
                    items: orderData.items,
                    total: orderData.totalAmount,
                    orderType: 'dine-in',
                    status: 'pending',
                    orderTime: new Date().toISOString()
                };
            } else {
                requestData = orderData;
            }

            fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(requestData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // 清除待處理訂單
                    localStorage.removeItem('pendingOrder');
                    if (isDineIn) {
                        localStorage.removeItem('dineInTableNumber');
                    }
                    
                    // 清空購物車
                    localStorage.removeItem('cart');
                    // 如果 window.cart 存在（在其他頁面），也清空它
                    if (typeof window.cart !== 'undefined') {
                        window.cart = [];
                    }
                    console.log('✅ 購物車已清空');
                    
                    alert('訂單已成功提交！');
                    window.location.href = 'menu.html';
                } else {
                    alert(data.message || '訂單提交失敗，請重試');
                    btn.disabled = false;
                    btn.textContent = '前往支付';
                }
            })
            .catch(error => {
                console.error('提交訂單失敗:', error);
                alert('提交訂單時發生錯誤，請重試');
                btn.disabled = false;
                btn.textContent = '前往支付';
            });
        }

        function goBack() {
            // 清除待處理訂單數據
            localStorage.removeItem('pendingOrder');
            // 返回菜單頁面
            window.location.href = 'menu.html';
        }

        // 頁面載入時初始化
        document.addEventListener('DOMContentLoaded', function() {
            loadOrderData();
        });
    </script>
</body>
</html>

