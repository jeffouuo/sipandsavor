<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¸æ“‡æ”¯ä»˜æ–¹å¼ - é£²èŒ¶è¶£</title>
    <link rel="icon" type="image/webp" href="/images/sipandsavor.webp">
    <link rel="shortcut icon" type="image/webp" href="/images/sipandsavor.webp">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' https:; script-src 'self' 'unsafe-inline' 'unsafe-eval' https:; style-src 'self' 'unsafe-inline' https:; font-src 'self' https:; img-src 'self' data: https:; connect-src 'self' https:; frame-src 'self' https:;">
    <link rel="stylesheet" href="style-optimized.css">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <style>
        .payment-container {
            max-width: 600px;
            margin: 100px auto;
            padding: 30px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        .payment-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .payment-header h1 {
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .order-summary {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
        }

        .order-summary h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.2em;
        }

        .order-item {
            padding: 12px 0;
            border-bottom: 1px solid #e0e0e0;
        }

        .order-item:last-child {
            border-bottom: none;
        }

        .order-item-main {
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px;
        }

        .order-item-details {
            font-size: 0.9em;
            color: #666;
            margin-top: 4px;
            padding-left: 0;
        }

        .order-item-special {
            color: #e74c3c;
            font-weight: 500;
        }

        .order-total {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 2px solid #2c3e50;
            font-size: 1.3em;
            font-weight: bold;
            color: #2c3e50;
        }

        .payment-methods {
            margin-bottom: 30px;
        }

        .payment-methods h3 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.2em;
        }

        .payment-option {
            display: flex;
            align-items: center;
            padding: 20px;
            margin-bottom: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
        }

        .payment-option:hover {
            border-color: #2ed573;
            background: #f0fff4;
        }

        .payment-option.selected {
            border-color: #2ed573;
            background: #e8f5e9;
        }

        .payment-option input[type="radio"] {
            margin-right: 15px;
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .payment-option label {
            flex: 1;
            cursor: pointer;
            display: flex;
            align-items: center;
            font-size: 1.1em;
            color: #2c3e50;
        }

        .payment-icon {
            font-size: 2em;
            margin-right: 15px;
            color: #2ed573;
        }

        .payment-actions {
            display: flex;
            gap: 15px;
        }

        .btn {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background-color: #2ed573;
            color: white;
        }

        .btn-primary:hover {
            background-color: #26d0ce;
        }

        .btn-secondary {
            background-color: #95a5a6;
            color: white;
        }

        .btn-secondary:hover {
            background-color: #7f8c8d;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        @media (max-width: 768px) {
            .payment-container {
                margin: 20px;
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="payment-container">
        <div class="payment-header">
            <h1>é¸æ“‡æ”¯ä»˜æ–¹å¼</h1>
            <p>è«‹é¸æ“‡æ‚¨çš„ä»˜æ¬¾æ–¹å¼</p>
        </div>

        <div class="order-summary" id="orderSummary">
            <h3>è¨‚å–®æ‘˜è¦</h3>
            <div id="orderItems"></div>
            <div class="order-total">
                <span>ç¸½è¨ˆï¼š</span>
                <span id="totalAmount">NT$ 0</span>
            </div>
        </div>

        <div class="payment-methods">
            <h3>æ”¯ä»˜æ–¹å¼</h3>
            <div class="payment-option" data-method="credit_card">
                <input type="radio" name="paymentMethod" id="credit_card" value="credit_card" checked>
                <label for="credit_card">
                    <span class="material-icons payment-icon">credit_card</span>
                    <span>ä¿¡ç”¨å¡</span>
                </label>
            </div>
            <div class="payment-option" data-method="cash">
                <input type="radio" name="paymentMethod" id="cash" value="cash">
                <label for="cash">
                    <span class="material-icons payment-icon">money</span>
                    <span>ç¾é‡‘æ”¯ä»˜ï¼ˆç¾å ´ä»˜æ¬¾ï¼‰</span>
                </label>
            </div>
        </div>

        <div class="payment-actions">
            <button class="btn btn-secondary" onclick="goBack()">è¿”å›</button>
            <button class="btn btn-primary" id="proceedBtn" type="button" onclick="proceedToPayment()">å‰å¾€æ”¯ä»˜</button>
        </div>
    </div>

    <script>
        // å¾ localStorage ç²å–è¨‚å–®æ•¸æ“š
        let orderData = null;

        function loadOrderData() {
            const storedData = localStorage.getItem('pendingOrder');
            if (!storedData) {
                alert('æ²’æœ‰æ‰¾åˆ°è¨‚å–®æ•¸æ“šï¼Œå°‡è¿”å›èœå–®é é¢');
                window.location.href = 'menu.html';
                return;
            }

            try {
                orderData = JSON.parse(storedData);
                displayOrderSummary();
            } catch (error) {
                console.error('è§£æè¨‚å–®æ•¸æ“šå¤±æ•—:', error);
                alert('è¨‚å–®æ•¸æ“šæ ¼å¼éŒ¯èª¤ï¼Œå°‡è¿”å›èœå–®é é¢');
                window.location.href = 'menu.html';
            }
        }

        function displayOrderSummary() {
            if (!orderData || !orderData.items) return;

            const itemsContainer = document.getElementById('orderItems');
            const totalAmountEl = document.getElementById('totalAmount');

            itemsContainer.innerHTML = '';
            let total = 0;

            orderData.items.forEach(item => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'order-item';
                
                const subtotal = (parseFloat(item.price) || 0) * (parseInt(item.quantity) || 1);
                total += subtotal;

                // æ§‹å»ºå•†å“é¡¯ç¤ºå…§å®¹
                let itemHTML = `
                    <div class="order-item-main">
                        <span>${item.name} x ${item.quantity}</span>
                        <span>NT$ ${subtotal.toLocaleString()}</span>
                    </div>
                `;

                // é¡¯ç¤ºç‰¹æ®Šéœ€æ±‚ï¼ˆå®¢åˆ¶åŒ–ä¿¡æ¯å’Œç‰¹æ®Šéœ€æ±‚ï¼‰
                const specialDetails = [];
                
                // æ·»åŠ å®¢åˆ¶åŒ–ä¿¡æ¯ï¼ˆå¦‚æœæœ‰ï¼‰
                if (item.customizations && item.customizations.trim()) {
                    specialDetails.push(item.customizations.trim());
                }
                
                // æ·»åŠ ç‰¹æ®Šéœ€æ±‚ï¼ˆå¦‚æœæœ‰ï¼‰
                if (item.specialRequest && item.specialRequest.trim()) {
                    specialDetails.push(`ç‰¹æ®Šéœ€æ±‚: ${item.specialRequest.trim()}`);
                }

                // å¦‚æœæœ‰ç‰¹æ®Šéœ€æ±‚ï¼Œé¡¯ç¤ºåœ¨å•†å“ä¸‹æ–¹
                if (specialDetails.length > 0) {
                    itemHTML += `
                        <div class="order-item-details">
                            <span class="order-item-special">${specialDetails.join(' | ')}</span>
                        </div>
                    `;
                }

                itemDiv.innerHTML = itemHTML;
                itemsContainer.appendChild(itemDiv);
            });

            totalAmountEl.textContent = `NT$ ${total.toLocaleString()}`;
            orderData.totalAmount = total;
        }

        // æ”¯ä»˜æ–¹å¼é¸æ“‡
        document.querySelectorAll('.payment-option').forEach(option => {
            option.addEventListener('click', function() {
                document.querySelectorAll('.payment-option').forEach(opt => {
                    opt.classList.remove('selected');
                });
                this.classList.add('selected');
                const radio = this.querySelector('input[type="radio"]');
                if (radio) {
                    radio.checked = true;
                }
            });
        });

        // åˆå§‹åŒ–é¸ä¸­ç‹€æ…‹
        document.querySelector('.payment-option[data-method="credit_card"]').classList.add('selected');

        function proceedToPayment() {
            const selectedMethod = document.querySelector('input[name="paymentMethod"]:checked');
            if (!selectedMethod) {
                alert('è«‹é¸æ“‡æ”¯ä»˜æ–¹å¼');
                return;
            }

            if (!orderData) {
                alert('è¨‚å–®æ•¸æ“šéŒ¯èª¤ï¼Œè«‹é‡æ–°ä¸‹å–®');
                window.location.href = 'menu.html';
                return;
            }

            // æ›´æ–°æ”¯ä»˜æ–¹å¼
            orderData.paymentMethod = selectedMethod.value;

            // å¦‚æœæ˜¯ç¾é‡‘æ”¯ä»˜ï¼Œç›´æ¥æäº¤è¨‚å–®
            if (selectedMethod.value === 'cash') {
                submitOrder();
                return;
            }

            // å¦‚æœæ˜¯ä¿¡ç”¨å¡æ”¯ä»˜ï¼Œå¾å¾Œç«¯ç²å–åƒæ•¸ä¸¦å‰µå»ºè¡¨å–®æäº¤
            if (selectedMethod.value === 'credit_card') {
                handleEcpayPayment();
                return;
            }

            // å¦‚æœé¸æ“‡äº†ä¸æ”¯æŒçš„æ”¯ä»˜æ–¹å¼
            alert('ä¸æ”¯æŒçš„æ”¯ä»˜æ–¹å¼ï¼Œè«‹é¸æ“‡ä¿¡ç”¨å¡æˆ–ç¾é‡‘æ”¯ä»˜');
        }

        // è™•ç†ç¶ ç•Œé‡‘æµæ”¯ä»˜
        // âœ… æ­£ç¢ºæµç¨‹ï¼š
        // 1. å‰ç«¯å¾å¾Œç«¯ç²å– JSON åƒæ•¸ï¼ˆä¸æ˜¯ HTMLï¼‰
        // 2. å‰ç«¯å»ºç«‹éš±è—çš„ <form>ï¼ŒæŠŠåƒæ•¸å¡«é€²å»
        // 3. åŸ·è¡Œ form.submit()
        // 4. æˆåŠŸæ¨™èªŒï¼šç€è¦½å™¨æ•´é ç™½å±ä¸¦æ›é ï¼Œç¶²å€åˆ—è®Šæˆ payment-stage.ecpay.com.tw
        async function handleEcpayPayment() {
            try {
                // æ­¥é©Ÿ 1ï¼šå¾å¾Œç«¯ç²å– JSON åƒæ•¸ï¼ˆä¸æ˜¯ HTMLï¼‰
                const response = await fetch('/api/ecpay/get-params', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        items: orderData.items,
                        totalAmount: orderData.totalAmount,
                        paymentMethod: 'Credit',
                        diningMode: localStorage.getItem('dineInTableNumber') ? 'dine-in' : 'takeout' // å‚³éç”¨é¤æ¨¡å¼çµ¦å¾Œç«¯
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'ç²å–æ”¯ä»˜åƒæ•¸å¤±æ•—');
                }

                const data = await response.json();
                
                if (!data.success) {
                    throw new Error(data.error || 'ç²å–æ”¯ä»˜åƒæ•¸å¤±æ•—');
                }

                // æ­¥é©Ÿ 2ï¼šå»ºç«‹éš±è—çš„ <form>ï¼ŒæŠŠåƒæ•¸å¡«é€²å»
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = 'https://payment-stage.ecpay.com.tw/Cashier/AioCheckOut/V5'; // ç¶ ç•Œæ¸¬è©¦ç’°å¢ƒç¶²å€
                form.style.display = 'none'; // éš±è—è¡¨å–®

                // å°‡æ‰€æœ‰åƒæ•¸ï¼ˆé™¤äº† successï¼‰æ·»åŠ åˆ°è¡¨å–®
                for (const [key, value] of Object.entries(data)) {
                    if (key !== 'success') {
                        const input = document.createElement('input');
                        input.type = 'hidden';
                        input.name = key;
                        input.value = value;
                        form.appendChild(input);
                    }
                }

                // å°‡è¡¨å–®æ·»åŠ åˆ° body
                document.body.appendChild(form);

                // æ­¥é©Ÿ 3ï¼šåŸ·è¡Œ form.submit()
                // âœ… æˆåŠŸæ¨™èªŒï¼šç€è¦½å™¨æ•´é ç™½å±ä¸¦æ›é ï¼Œç¶²å€åˆ—è®Šæˆ payment-stage.ecpay.com.tw
                // âœ… æ­¤æ™‚æ‚¨çš„ç¶²ç«™å·²ç¶“æ¶ˆå¤±ï¼Œç•¶ç„¶å°±ä¸æœƒæœ‰ä»»ä½•å ±éŒ¯
                console.log('ğŸš€ æäº¤è¡¨å–®åˆ°ç¶ ç•Œï¼Œç€è¦½å™¨å°‡æ•´é è·³è½‰...');
                form.submit();
            } catch (error) {
                console.error('âŒ æ”¯ä»˜è™•ç†å¤±æ•—:', error);
                alert('æ”¯ä»˜è™•ç†å¤±æ•—ï¼š' + error.message);
            }
        }

        function submitOrder() {
            const btn = document.getElementById('proceedBtn');
            btn.disabled = true;
            btn.textContent = 'è™•ç†ä¸­...';

            // æª¢æŸ¥æ˜¯å¦ç‚ºå…§ç”¨è¨‚å–®
            const isDineIn = localStorage.getItem('dineInTableNumber');
            const url = isDineIn ? '/api/orders/dine-in' : '/api/orders/checkout';

            let requestData;
            if (isDineIn) {
                requestData = {
                    tableNumber: localStorage.getItem('dineInTableNumber'),
                    area: 'å…§ç”¨å€',
                    items: orderData.items,
                    total: orderData.totalAmount,
                    orderType: 'dine-in',
                    status: 'pending',
                    orderTime: new Date().toISOString()
                };
            } else {
                requestData = orderData;
            }

            fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(requestData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // æ¸…é™¤å¾…è™•ç†è¨‚å–®
                    localStorage.removeItem('pendingOrder');
                    if (isDineIn) {
                        localStorage.removeItem('dineInTableNumber');
                    }
                    
                    // æ¸…ç©ºè³¼ç‰©è»Š
                    localStorage.removeItem('cart');
                    // å¦‚æœ window.cart å­˜åœ¨ï¼ˆåœ¨å…¶ä»–é é¢ï¼‰ï¼Œä¹Ÿæ¸…ç©ºå®ƒ
                    if (typeof window.cart !== 'undefined') {
                        window.cart = [];
                    }
                    console.log('âœ… è³¼ç‰©è»Šå·²æ¸…ç©º');
                    
                    alert('è¨‚å–®å·²æˆåŠŸæäº¤ï¼');
                    window.location.href = 'menu.html';
                } else {
                    alert(data.message || 'è¨‚å–®æäº¤å¤±æ•—ï¼Œè«‹é‡è©¦');
                    btn.disabled = false;
                    btn.textContent = 'å‰å¾€æ”¯ä»˜';
                }
            })
            .catch(error => {
                console.error('æäº¤è¨‚å–®å¤±æ•—:', error);
                alert('æäº¤è¨‚å–®æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹é‡è©¦');
                btn.disabled = false;
                btn.textContent = 'å‰å¾€æ”¯ä»˜';
            });
        }

        function goBack() {
            // æ¸…é™¤å¾…è™•ç†è¨‚å–®æ•¸æ“š
            localStorage.removeItem('pendingOrder');
            // è¿”å›èœå–®é é¢
            window.location.href = 'menu.html';
        }

        // é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            loadOrderData();
        });
    </script>
</body>
</html>

