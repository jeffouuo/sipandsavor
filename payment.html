<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¸æ“‡æ”¯ä»˜æ–¹å¼ - é£²èŒ¶è¶£</title>
    <link rel="icon" type="image/webp" href="/images/sipandsavor.webp">
    <link rel="shortcut icon" type="image/webp" href="/images/sipandsavor.webp">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' https:; script-src 'self' 'unsafe-inline' 'unsafe-eval' https:; style-src 'self' 'unsafe-inline' https:; font-src 'self' https:; img-src 'self' data: https:; connect-src 'self' https:; frame-src 'self' https:;">
    <link rel="stylesheet" href="style-optimized.css">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <style>
        .payment-container {
            max-width: 600px;
            margin: 100px auto;
            padding: 30px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        .payment-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .payment-header h1 {
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .order-summary {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
        }

        .order-summary h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.2em;
        }

        .order-item {
            padding: 12px 0;
            border-bottom: 1px solid #e0e0e0;
        }

        .order-item:last-child {
            border-bottom: none;
        }

        .order-item-main {
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px;
        }

        .order-item-details {
            font-size: 0.9em;
            color: #666;
            margin-top: 4px;
            padding-left: 0;
        }

        .order-item-special {
            color: #e74c3c;
            font-weight: 500;
        }

        .order-total {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 2px solid #2c3e50;
            font-size: 1.3em;
            font-weight: bold;
            color: #2c3e50;
        }

        .payment-methods {
            margin-bottom: 30px;
        }

        .payment-methods h3 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.2em;
        }

        .payment-option {
            display: flex;
            align-items: center;
            padding: 20px;
            margin-bottom: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
        }

        .payment-option:hover {
            border-color: #2ed573;
            background: #f0fff4;
        }

        .payment-option.selected {
            border-color: #2ed573;
            background: #e8f5e9;
        }

        .payment-option input[type="radio"] {
            margin-right: 15px;
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .payment-option label {
            flex: 1;
            cursor: pointer;
            display: flex;
            align-items: center;
            font-size: 1.1em;
            color: #2c3e50;
        }

        .payment-icon {
            font-size: 2em;
            margin-right: 15px;
            color: #2ed573;
        }

        .payment-actions {
            display: flex;
            gap: 15px;
        }

        .btn {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background-color: #2ed573;
            color: white;
        }

        .btn-primary:hover {
            background-color: #26d0ce;
        }

        .btn-secondary {
            background-color: #95a5a6;
            color: white;
        }

        .btn-secondary:hover {
            background-color: #7f8c8d;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        @media (max-width: 768px) {
            .payment-container {
                margin: 20px;
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="payment-container">
        <div class="payment-header">
            <h1>é¸æ“‡æ”¯ä»˜æ–¹å¼</h1>
            <p>è«‹é¸æ“‡æ‚¨çš„ä»˜æ¬¾æ–¹å¼</p>
        </div>

        <div class="order-summary" id="orderSummary">
            <h3>è¨‚å–®æ‘˜è¦</h3>
            <div id="orderItems"></div>
            <div class="order-total">
                <span>ç¸½è¨ˆï¼š</span>
                <span id="totalAmount">NT$ 0</span>
            </div>
        </div>

        <div class="order-table-number" id="dineInTableSection" style="display: none; margin-bottom: 30px;">
            <h3 style="color: #2c3e50; margin-bottom: 10px; font-size: 1.1em;">å…§ç”¨æ¡Œè™Ÿ</h3>
            <input 
                type="text"
                id="tableNumber"
                placeholder="è«‹è¼¸å…¥æ¡Œè™Ÿï¼ˆä¾‹å¦‚ B2ï¼‰"
                style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; font-family: inherit;"
                maxlength="8"
            />
            <small style="color: #666; font-size: 12px; display: block; margin-top: 5px;">åƒ…é™è¼¸å…¥è‹±æ•¸å­—ï¼Œä¾‹å¦‚ï¼š5ã€A1ã€B2</small>
        </div>

        <div class="order-notes" style="margin-bottom: 30px;">
            <h3 style="color: #2c3e50; margin-bottom: 15px; font-size: 1.2em;">è¨‚å–®å‚™è¨»ï¼ˆé¸å¡«ï¼‰</h3>
            <textarea 
                id="orderSpecialRequest" 
                placeholder="è«‹è¼¸å…¥è¨‚å–®å‚™è¨»æˆ–ç‰¹æ®Šéœ€æ±‚ï¼ˆä¾‹å¦‚ï¼šå¤šå†°ã€å°‘ç³–ç­‰ï¼‰" 
                style="width: 100%; min-height: 80px; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; font-family: inherit; resize: vertical;"
                maxlength="200"
            ></textarea>
            <small style="color: #666; font-size: 12px; display: block; margin-top: 5px;">æœ€å¤š200å€‹å­—ç¬¦</small>
        </div>

        <div class="payment-methods">
            <h3>æ”¯ä»˜æ–¹å¼</h3>
            <div class="payment-option" data-method="credit_card">
                <input type="radio" name="paymentMethod" id="credit_card" value="credit_card" checked>
                <label for="credit_card">
                    <span class="material-icons payment-icon">credit_card</span>
                    <span>ä¿¡ç”¨å¡</span>
                </label>
            </div>
            <div class="payment-option" data-method="cash">
                <input type="radio" name="paymentMethod" id="cash" value="cash">
                <label for="cash">
                    <span class="material-icons payment-icon">money</span>
                    <span>ç¾é‡‘æ”¯ä»˜ï¼ˆç¾å ´ä»˜æ¬¾ï¼‰</span>
                </label>
            </div>
        </div>

        <div class="payment-actions">
            <button class="btn btn-secondary" onclick="goBack()">è¿”å›</button>
            <button class="btn btn-primary" id="proceedBtn" type="button" onclick="proceedToPayment()">å‰å¾€æ”¯ä»˜</button>
        </div>
    </div>

    <script>
        // å¾ localStorage ç²å–è¨‚å–®æ•¸æ“š
        let orderData = null;

        function loadOrderData() {
            const storedData = localStorage.getItem('pendingOrder');
            if (!storedData) {
                alert('æ²’æœ‰æ‰¾åˆ°è¨‚å–®æ•¸æ“šï¼Œå°‡è¿”å›èœå–®é é¢');
                window.location.href = 'menu.html';
                return;
            }

            try {
                orderData = JSON.parse(storedData);
                const sessionContext = getSessionDiningContext();
                console.log('çµå¸³é è®€å–åˆ°çš„æ¡Œè™Ÿ (sessionStorage):', sessionContext.tableNumber || '(ç„¡)');
                const fallbackTableNumber = localStorage.getItem('dineInTableNumber');
                if (!orderData.tableNumber) {
                    orderData.tableNumber = sessionContext.tableNumber || fallbackTableNumber || null;
                }
                if (!orderData.diningMode) {
                    orderData.diningMode = sessionContext.diningMode || (orderData.tableNumber ? 'dine-in' : 'takeout');
                }
                if (!orderData.deliveryMethod) {
                    orderData.deliveryMethod = orderData.diningMode === 'dine-in' ? 'dine-in' : 'pickup';
                }
                displayOrderSummary();
                prefillSpecialRequest();
                initTableNumberSection();
            } catch (error) {
                console.error('è§£æè¨‚å–®æ•¸æ“šå¤±æ•—:', error);
                alert('è¨‚å–®æ•¸æ“šæ ¼å¼éŒ¯èª¤ï¼Œå°‡è¿”å›èœå–®é é¢');
                window.location.href = 'menu.html';
            }
        }

function buildAggregationLine(item = {}) {
    const name = item?.name ? String(item.name).trim() : '';
    if (!name) return '';

    const noteText = buildItemNoteText(item);
    const cleanNote = noteText.replace(/^å‚™è¨»ï¼š\s*/, '').trim();
    if (!cleanNote) return '';

    return `${name}: ${cleanNote}`;
}

        function collectSpecialRequests(items = []) {
            if (!Array.isArray(items)) return '';

            const lines = [];
            items.forEach(item => {
                const line = buildAggregationLine(item);
                if (line) {
                    lines.push(line);
                }
            });

            return lines.join('\n');
        }

        function getSessionDiningContext() {
            if (typeof sessionStorage === 'undefined') {
                return { tableNumber: null, diningMode: null };
            }
            try {
                return {
                    tableNumber: sessionStorage.getItem('tableNumber'),
                    diningMode: sessionStorage.getItem('diningMode')
                };
            } catch (error) {
                console.warn('è®€å– sessionStorage å¤±æ•—:', error);
                return { tableNumber: null, diningMode: null };
            }
        }

        function saveSessionDiningContext(tableNumber, diningMode) {
            if (typeof sessionStorage === 'undefined') return;
            try {
                if (tableNumber && tableNumber.trim()) {
                    sessionStorage.setItem('tableNumber', tableNumber.trim());
                } else {
                    sessionStorage.removeItem('tableNumber');
                }
                if (diningMode) {
                    sessionStorage.setItem('diningMode', diningMode);
                } else {
                    sessionStorage.removeItem('diningMode');
                }
            } catch (error) {
                console.warn('ç„¡æ³•å¯«å…¥ sessionStorage:', error);
            }
        }

        function clearDiningContextStorage() {
            localStorage.removeItem('dineInTableNumber');
            if (typeof sessionStorage !== 'undefined') {
                try {
                    sessionStorage.removeItem('tableNumber');
                    sessionStorage.removeItem('diningMode');
                } catch (error) {
                    console.warn('ç„¡æ³•æ¸…é™¤ sessionStorage:', error);
                }
            }
        }

        function getTableNumberInputElement() {
            return document.getElementById('tableNumber') ||
                document.getElementById('tableNumberInput') ||
                document.getElementById('orderTableNumber');
        }

        function readTableNumberInputValue() {
            const input = getTableNumberInputElement();
            if (!input) return '';
            return (input.value || '').trim();
        }

        function normalizeTableNumber(value = '') {
            return value.replace(/[^a-zA-Z0-9]/g, '').toUpperCase();
        }

        function getCurrentTableNumber() {
            const inputValue = readTableNumberInputValue();
            if (inputValue) {
                return normalizeTableNumber(inputValue);
            }
            if (orderData && orderData.tableNumber && orderData.tableNumber.trim()) {
                return normalizeTableNumber(orderData.tableNumber.trim());
            }
            const sessionContext = getSessionDiningContext();
            if (sessionContext.tableNumber && sessionContext.tableNumber.trim()) {
                return normalizeTableNumber(sessionContext.tableNumber.trim());
            }
            const stored = localStorage.getItem('dineInTableNumber');
            return stored ? normalizeTableNumber(stored) : '';
        }

        function resolveTableNumberForSubmission() {
            const inputValue = readTableNumberInputValue();
            if (inputValue) {
                const normalized = normalizeTableNumber(inputValue);
                const input = getTableNumberInputElement();
                if (input) {
                    input.value = normalized;
                }
                orderData = orderData || {};
                orderData.tableNumber = normalized;
                saveSessionDiningContext(normalized, 'dine-in');
                localStorage.setItem('dineInTableNumber', normalized);
                return normalized;
            }
            const current = getCurrentTableNumber();
            if (current) {
                orderData = orderData || {};
                orderData.tableNumber = current;
                saveSessionDiningContext(current, orderData.diningMode || 'dine-in');
                localStorage.setItem('dineInTableNumber', current);
                return current;
            }
            return '';
        }

        function captureLiveTableNumber() {
            const input = getTableNumberInputElement();
            if (!input) return '';
            const raw = (input.value || '').trim();
            if (!raw) {
                return '';
            }
            const normalized = normalizeTableNumber(raw);
            if (input.value !== normalized) {
                input.value = normalized;
            }
            orderData = orderData || {};
            orderData.tableNumber = normalized;
            saveSessionDiningContext(normalized, orderData.diningMode || 'dine-in');
            localStorage.setItem('dineInTableNumber', normalized);
            return normalized;
        }

        function initTableNumberSection() {
            const section = document.getElementById('dineInTableSection');
            const input = getTableNumberInputElement();
            if (!section || !input) return;

            const sessionContext = getSessionDiningContext();
            const storedCandidate = (sessionContext.tableNumber && sessionContext.tableNumber.trim())
                ? sessionContext.tableNumber.trim()
                : (localStorage.getItem('dineInTableNumber') || '');
            const shouldShow = Boolean(
                (orderData && (orderData.diningMode === 'dine-in' || orderData.deliveryMethod === 'dine-in')) ||
                (storedCandidate && storedCandidate.trim())
            );

            if (!shouldShow) {
                section.style.display = 'none';
                input.value = '';
                return;
            }

            section.style.display = 'block';
            const initialValue = normalizeTableNumber(
                (orderData && orderData.tableNumber) ||
                storedCandidate ||
                ''
            );
            if (initialValue) {
                input.value = initialValue;
                orderData.tableNumber = initialValue;
                orderData.diningMode = orderData.diningMode || 'dine-in';
            }

            input.addEventListener('input', () => {
                const normalized = normalizeTableNumber(input.value);
                if (input.value !== normalized) {
                    input.value = normalized;
                }
                orderData.tableNumber = normalized || null;
                if (normalized) {
                    orderData.diningMode = 'dine-in';
                    saveSessionDiningContext(normalized, 'dine-in');
                    localStorage.setItem('dineInTableNumber', normalized);
                } else {
                    saveSessionDiningContext('', orderData.diningMode);
                }
            });
        }

        const STANDARD_SUGAR_LEVELS = ['ç„¡ç³–', 'å¾®ç³–', 'åŠç³–', 'å°‘ç³–', 'å…¨ç³–', 'æ­£å¸¸ç³–'];
        const STANDARD_ICE_LEVELS = ['å»å†°', 'å¾®å†°', 'å°‘å†°', 'æ­£å¸¸å†°', 'ç†±é£²'];

        function parseLegacyCustomizations(customizations = '') {
            const result = {
                sugarLevel: '',
                iceLevel: '',
                toppings: [],
                extras: []
            };

            if (!customizations || typeof customizations !== 'string') {
                return result;
            }

            const trimmed = customizations.trim();
            if (!trimmed) {
                return result;
            }

            let baseText = trimmed;
            const plusIndex = trimmed.indexOf('+');
            if (plusIndex >= 0) {
                const toppingsText = trimmed.slice(plusIndex + 1);
                toppingsText.split(/[,ï¼Œ]/).forEach(topping => {
                    const clean = topping.trim();
                    if (clean) {
                        result.toppings.push(clean);
                    }
                });
                baseText = trimmed.slice(0, plusIndex);
            }

            baseText.split(',').forEach(token => {
                const clean = token.trim();
                if (!clean) return;

                if (!result.sugarLevel && STANDARD_SUGAR_LEVELS.includes(clean)) {
                    result.sugarLevel = clean;
                } else if (!result.iceLevel && STANDARD_ICE_LEVELS.includes(clean)) {
                    result.iceLevel = clean;
                } else {
                    result.extras.push(clean);
                }
            });

            return result;
        }

        function getItemCustomizationMeta(item = {}) {
            const meta = {
                sugarLevel: item?.sugarLevel ? String(item.sugarLevel).trim() : '',
                iceLevel: item?.iceLevel ? String(item.iceLevel).trim() : '',
                toppings: Array.isArray(item?.toppings) ? item.toppings.filter(Boolean).map(t => String(t).trim()) : [],
                extras: []
            };

            if (Array.isArray(item?.extras)) {
                meta.extras = item.extras.filter(Boolean).map(extra => String(extra).trim());
            }

            const needsLegacy = !meta.sugarLevel || !meta.iceLevel || meta.toppings.length === 0;
            if ((needsLegacy || meta.extras.length === 0) && item?.customizations) {
                const legacy = parseLegacyCustomizations(item.customizations);
                if (!meta.sugarLevel && legacy.sugarLevel) meta.sugarLevel = legacy.sugarLevel;
                if (!meta.iceLevel && legacy.iceLevel) meta.iceLevel = legacy.iceLevel;
                if (meta.toppings.length === 0 && legacy.toppings.length > 0) meta.toppings = legacy.toppings;
                if (meta.extras.length === 0 && legacy.extras.length > 0) meta.extras = legacy.extras;
            }

            return meta;
        }

        function formatItemDisplayName(item = {}) {
            const meta = getItemCustomizationMeta(item);
            const baseParts = [];
            if (meta.sugarLevel) baseParts.push(meta.sugarLevel);
            if (meta.iceLevel) baseParts.push(meta.iceLevel);

            let display = item?.name ? String(item.name) : 'æœªçŸ¥å•†å“';
            if (baseParts.length) {
                display += ` (${baseParts.join(', ')})`;
            }

            return display;
        }

        function getItemSpecialRequest(item = {}) {
            const candidates = [
                item?.specialRequest,
                item?.note,
                item?.notes
            ];
            for (const value of candidates) {
                if (value && String(value).trim()) {
                    return String(value).trim();
                }
            }
            return '';
        }

        function buildItemNoteText(item = {}) {
            const meta = getItemCustomizationMeta(item);
            const noteSegments = [];

            if (meta.toppings.length) {
                noteSegments.push(`+ ${meta.toppings.join(', ')}`);
            }
            if (meta.extras.length) {
                noteSegments.push(meta.extras.join(', '));
            }

            const specialRequest = getItemSpecialRequest(item);
            if (specialRequest) {
                noteSegments.push(specialRequest);
            }

            const noteContent = noteSegments.join(' ').trim();
            return noteContent ? `å‚™è¨»ï¼š${noteContent}` : '';
        }

        // âš ï¸ é—œéµä¿®å¾©ï¼šè‡ªå‹•å¸¶å…¥è³¼ç‰©è»Šå•†å“çš„ç‰¹æ®Šéœ€æ±‚
        function prefillSpecialRequest() {
            const noteInput = document.getElementById('orderSpecialRequest');
            if (!noteInput) return;

            let prefValue = '';

            if (orderData && Array.isArray(orderData.items)) {
                prefValue = collectSpecialRequests(orderData.items);
            }

            if (!prefValue) {
                try {
                    const cartItems = JSON.parse(localStorage.getItem('cart') || '[]');
                    prefValue = collectSpecialRequests(cartItems);
                } catch (error) {
                    console.warn('âš ï¸ ç„¡æ³•è§£æè³¼ç‰©è»Šè³‡æ–™ç”¨æ–¼å‚™è¨»è‡ªå‹•å¡«å…¥:', error);
                }
            }

            if (!prefValue && orderData && orderData.specialRequest) {
                prefValue = orderData.specialRequest.trim();
            }

            noteInput.value = prefValue || '';
            if (orderData) {
                orderData.specialRequest = prefValue || '';
            }

            if (prefValue) {
                console.log('ğŸ”„ è‡ªå‹•å¡«å…¥è¨‚å–®å‚™è¨»:', prefValue);
            } else {
                console.log('â„¹ï¸ æ²’æœ‰å¯è‡ªå‹•å¡«å…¥çš„å‚™è¨»');
            }
        }

        function displayOrderSummary() {
            if (!orderData || !orderData.items) return;

            const itemsContainer = document.getElementById('orderItems');
            const totalAmountEl = document.getElementById('totalAmount');

            itemsContainer.innerHTML = '';
            let total = 0;

            orderData.items.forEach(item => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'order-item';
                
                const subtotal = (parseFloat(item.price) || 0) * (parseInt(item.quantity) || 1);
                total += subtotal;

                const displayName = formatItemDisplayName(item);
                const noteText = buildItemNoteText(item);
                
                // æ§‹å»ºå•†å“é¡¯ç¤ºå…§å®¹
                let itemHTML = `
                    <div class="order-item-main">
                        <span>${displayName} x ${item.quantity}</span>
                        <span>NT$ ${subtotal.toLocaleString()}</span>
                    </div>
                `;

                // 2. ç‰¹æ®Šéœ€æ±‚ï¼ˆç¨ç«‹é¡¯ç¤ºåœ¨ä¸‹æ–¹ï¼Œç´…è‰²å°å­—ï¼‰
                if (noteText) {
                    itemHTML += `
                        <div class="order-item-details">
                            <span class="order-item-special text-red-500" style="color: #e74c3c; font-size: 12px; font-weight: 500;">
                                ${noteText}
                            </span>
                        </div>
                    `;
                }

                itemDiv.innerHTML = itemHTML;
                itemsContainer.appendChild(itemDiv);
            });

            totalAmountEl.textContent = `NT$ ${total.toLocaleString()}`;
            orderData.totalAmount = total;
        }

        // æ”¯ä»˜æ–¹å¼é¸æ“‡
        document.querySelectorAll('.payment-option').forEach(option => {
            option.addEventListener('click', function() {
                document.querySelectorAll('.payment-option').forEach(opt => {
                    opt.classList.remove('selected');
                });
                this.classList.add('selected');
                const radio = this.querySelector('input[type="radio"]');
                if (radio) {
                    radio.checked = true;
                }
            });
        });

        // åˆå§‹åŒ–é¸ä¸­ç‹€æ…‹
        document.querySelector('.payment-option[data-method="credit_card"]').classList.add('selected');

        function proceedToPayment() {
            const selectedMethod = document.querySelector('input[name="paymentMethod"]:checked');
            if (!selectedMethod) {
                alert('è«‹é¸æ“‡æ”¯ä»˜æ–¹å¼');
                return;
            }

            if (!orderData) {
                alert('è¨‚å–®æ•¸æ“šéŒ¯èª¤ï¼Œè«‹é‡æ–°ä¸‹å–®');
                window.location.href = 'menu.html';
                return;
            }

            // âš ï¸ é—œéµä¿®å¾© 1ï¼šè®€å–è¨‚å–®ç´šåˆ¥çš„å‚™è¨»è¼¸å…¥æ¡†
            const noteInput = document.getElementById('orderSpecialRequest');
            const specialRequestValue = noteInput ? (noteInput.value || '').trim() : '';
            const resolvedTableNumber = resolveTableNumberForSubmission();
            const expectsTableNumber = (orderData && orderData.diningMode === 'dine-in') || Boolean(resolvedTableNumber);
            const finalTableNumber = expectsTableNumber ? resolvedTableNumber : '';
            if (expectsTableNumber && !finalTableNumber) {
                alert('è«‹è¼¸å…¥å…§ç”¨æ¡Œè™Ÿå¾Œå†é€å‡º');
                return;
            }
            console.log('å‰ç«¯æº–å‚™é€å‡ºçš„æ¡Œè™Ÿ:', expectsTableNumber ? finalTableNumber : '(éå…§ç”¨)');
            
            // ğŸ” èª¿è©¦ï¼šè¨˜éŒ„å®¢äººè¼¸å…¥çš„å‚™è¨»å…§å®¹
            console.log('å®¢äººè¼¸å…¥çš„å‚™è¨»å…§å®¹:', specialRequestValue);
            
            // æ›´æ–°è¨‚å–®æ•¸æ“šï¼ŒåŒ…å« specialRequest
            orderData.paymentMethod = selectedMethod.value;
            orderData.specialRequest = specialRequestValue || null; // æ˜ç¢ºè¨­ç½® specialRequest
            orderData.tableNumber = expectsTableNumber ? (finalTableNumber || null) : null;
            orderData.diningMode = expectsTableNumber ? 'dine-in' : (orderData.diningMode || 'takeout');

            // å¦‚æœæ˜¯ç¾é‡‘æ”¯ä»˜ï¼Œç›´æ¥æäº¤è¨‚å–®
            if (selectedMethod.value === 'cash') {
                submitOrder();
                return;
            }

            // å¦‚æœæ˜¯ä¿¡ç”¨å¡æ”¯ä»˜ï¼Œå¾å¾Œç«¯ç²å–åƒæ•¸ä¸¦å‰µå»ºè¡¨å–®æäº¤
            if (selectedMethod.value === 'credit_card') {
                handleEcpayPayment();
                return;
            }

            // å¦‚æœé¸æ“‡äº†ä¸æ”¯æŒçš„æ”¯ä»˜æ–¹å¼
            alert('ä¸æ”¯æŒçš„æ”¯ä»˜æ–¹å¼ï¼Œè«‹é¸æ“‡ä¿¡ç”¨å¡æˆ–ç¾é‡‘æ”¯ä»˜');
        }

        // è™•ç†ç¶ ç•Œé‡‘æµæ”¯ä»˜
        // âœ… æ­£ç¢ºæµç¨‹ï¼š
        // 1. å‰ç«¯å¾å¾Œç«¯ç²å– JSON åƒæ•¸ï¼ˆä¸æ˜¯ HTMLï¼‰
        // 2. å‰ç«¯å»ºç«‹éš±è—çš„ <form>ï¼ŒæŠŠåƒæ•¸å¡«é€²å»
        // 3. åŸ·è¡Œ form.submit()
        // 4. æˆåŠŸæ¨™èªŒï¼šç€è¦½å™¨æ•´é ç™½å±ä¸¦æ›é ï¼Œç¶²å€åˆ—è®Šæˆ payment-stage.ecpay.com.tw
        async function handleEcpayPayment() {
            try {
                // âš ï¸ é—œéµä¿®å¾© 4ï¼šè®€å–è¨‚å–®ç´šåˆ¥çš„å‚™è¨»èˆ‡æ¡Œè™Ÿï¼ˆä¿¡ç”¨å¡æ”¯ä»˜æ™‚ä¹Ÿè¦è®€å–ï¼‰
                const noteInput = document.getElementById('orderSpecialRequest');
                const specialRequestValue = noteInput ? (noteInput.value || '').trim() : '';
                const sessionContext = getSessionDiningContext();

                const tableInputEl = document.getElementById('tableNumber');
                const domTableValue = tableInputEl ? (tableInputEl.value || '') : '';
                console.log('ğŸ›‘ [DEBUG] æŒ‰ä¸‹æŒ‰éˆ•ç¬é–“æŠ“åˆ°çš„æ¡Œè™Ÿ (ä¿¡ç”¨å¡):', domTableValue);
                const normalizedDomValue = normalizeTableNumber(domTableValue);
                if (tableInputEl && tableInputEl.value !== normalizedDomValue) {
                    tableInputEl.value = normalizedDomValue;
                }
                const fallbackTableNumber = orderData && orderData.tableNumber
                    ? normalizeTableNumber(orderData.tableNumber)
                    : '';
                const resolvedTableNumber = normalizedDomValue || fallbackTableNumber;
                const expectsTableNumber = (orderData && orderData.diningMode === 'dine-in') || Boolean(resolvedTableNumber);
                if (expectsTableNumber && !resolvedTableNumber) {
                    alert('è«‹è¼¸å…¥å…§ç”¨æ¡Œè™Ÿå¾Œå†é€å‡º');
                    return;
                }
                console.log('çµå¸³é è®€å–åˆ°çš„æ¡Œè™Ÿ (è¼¸å…¥æ¡†/ä¿¡ç”¨å¡):', normalizedDomValue || '(ç„¡)');
                
                // ğŸ” èª¿è©¦ï¼šè¨˜éŒ„å®¢äººè¼¸å…¥çš„å‚™è¨»å…§å®¹
                console.log('å®¢äººè¼¸å…¥çš„å‚™è¨»å…§å®¹ (ä¿¡ç”¨å¡æ”¯ä»˜):', specialRequestValue);
                
                // æ­¥é©Ÿ 1ï¼šå¾å¾Œç«¯ç²å– JSON åƒæ•¸ï¼ˆä¸æ˜¯ HTMLï¼‰
                const tableNumber = expectsTableNumber ? (resolvedTableNumber || null) : null;
                orderData.tableNumber = tableNumber;
                orderData.diningMode = expectsTableNumber ? 'dine-in' : (sessionContext.diningMode || orderData.diningMode || 'takeout');
                const diningMode = orderData.diningMode;

                const payload = {
                    items: orderData.items,
                    totalAmount: orderData.totalAmount,
                    paymentMethod: 'Credit',
                    diningMode,
                    specialRequest: specialRequestValue || null, // âš ï¸ é—œéµï¼šä½¿ç”¨è®€å–åˆ°çš„å€¼ï¼Œçµ±ä¸€è®Šæ•¸åç¨±ç‚º specialRequest
                    tableNumber
                };

                console.log('é€å‡ºçš„ç‰¹æ®Šéœ€æ±‚:', payload.specialRequest);
                console.log('æº–å‚™é€å‡ºçš„æ¡Œè™Ÿ:', payload.tableNumber || (expectsTableNumber ? '(æœªå¡«å¯«)' : '(éå…§ç”¨)'));
                console.log('å‰ç«¯é€å‡ºçš„ Payload:', payload);

                const response = await fetch('/api/ecpay/get-params', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'ç²å–æ”¯ä»˜åƒæ•¸å¤±æ•—');
                }

                const data = await response.json();
                
                if (!data.success) {
                    throw new Error(data.error || 'ç²å–æ”¯ä»˜åƒæ•¸å¤±æ•—');
                }

                // æ­¥é©Ÿ 2ï¼šå»ºç«‹éš±è—çš„ <form>ï¼ŒæŠŠåƒæ•¸å¡«é€²å»
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = 'https://payment-stage.ecpay.com.tw/Cashier/AioCheckOut/V5'; // ç¶ ç•Œæ¸¬è©¦ç’°å¢ƒç¶²å€
                form.style.display = 'none'; // éš±è—è¡¨å–®

                // å°‡æ‰€æœ‰åƒæ•¸ï¼ˆé™¤äº† successï¼‰æ·»åŠ åˆ°è¡¨å–®
                for (const [key, value] of Object.entries(data)) {
                    if (key !== 'success') {
                        const input = document.createElement('input');
                        input.type = 'hidden';
                        input.name = key;
                        input.value = value;
                        form.appendChild(input);
                    }
                }

                // å°‡è¡¨å–®æ·»åŠ åˆ° body
                document.body.appendChild(form);

                // æ­¥é©Ÿ 3ï¼šåŸ·è¡Œ form.submit()
                // âœ… æˆåŠŸæ¨™èªŒï¼šç€è¦½å™¨æ•´é ç™½å±ä¸¦æ›é ï¼Œç¶²å€åˆ—è®Šæˆ payment-stage.ecpay.com.tw
                // âœ… æ­¤æ™‚æ‚¨çš„ç¶²ç«™å·²ç¶“æ¶ˆå¤±ï¼Œç•¶ç„¶å°±ä¸æœƒæœ‰ä»»ä½•å ±éŒ¯
                console.log('ğŸš€ æäº¤è¡¨å–®åˆ°ç¶ ç•Œï¼Œç€è¦½å™¨å°‡æ•´é è·³è½‰...');
                form.submit();
            } catch (error) {
                console.error('âŒ æ”¯ä»˜è™•ç†å¤±æ•—:', error);
                alert('æ”¯ä»˜è™•ç†å¤±æ•—ï¼š' + error.message);
            }
        }

        function submitOrder() {
            const btn = document.getElementById('proceedBtn');
            btn.disabled = true;
            btn.textContent = 'è™•ç†ä¸­...';

            // âš ï¸ é—œéµä¿®å¾© 2ï¼šè®€å–è¨‚å–®ç´šåˆ¥çš„å‚™è¨»è¼¸å…¥æ¡†ï¼ˆç¾é‡‘æ”¯ä»˜æ™‚ä¹Ÿè¦è®€å–ï¼‰
            const noteInput = document.getElementById('orderSpecialRequest');
            const specialRequestValue = noteInput ? (noteInput.value || '').trim() : '';
            const sessionContext = getSessionDiningContext();

            // âœ… é‡æ–°è®€å–å…§ç”¨æ¡Œè™Ÿï¼ˆèˆ‡ HTML id `tableNumber` å°æ‡‰ï¼‰ï¼Œç¢ºä¿é€å‡ºå‰å–å¾—æœ€æ–°å€¼
            const tableInputEl = document.getElementById('tableNumber');
            const domTableValue = tableInputEl ? (tableInputEl.value || '') : '';
            console.log('ğŸ›‘ [DEBUG] æŒ‰ä¸‹æŒ‰éˆ•ç¬é–“æŠ“åˆ°çš„æ¡Œè™Ÿ:', domTableValue);
            const normalizedDomValue = normalizeTableNumber(domTableValue);
            if (tableInputEl && tableInputEl.value !== normalizedDomValue) {
                tableInputEl.value = normalizedDomValue;
            }
            const fallbackTableNumber = orderData && orderData.tableNumber ? normalizeTableNumber(orderData.tableNumber) : '';
            const resolvedTableNumber = normalizedDomValue || fallbackTableNumber;
            const expectsTableNumber = (orderData && orderData.diningMode === 'dine-in') || Boolean(resolvedTableNumber);
            if (expectsTableNumber && !resolvedTableNumber) {
                alert('è«‹è¼¸å…¥å…§ç”¨æ¡Œè™Ÿ');
                btn.disabled = false;
                btn.textContent = 'å‰å¾€æ”¯ä»˜';
                return;
            }
            const finalTableNumber = expectsTableNumber ? resolvedTableNumber : '';
            console.log('ğŸ›‘ [DEBUG] æº–å‚™é€å‡ºçš„æ¡Œè™Ÿ:', finalTableNumber || '(ç©ºå­—ä¸²)');
            console.log('å‰ç«¯æº–å‚™é€å‡ºçš„æ¡Œè™Ÿ:', expectsTableNumber ? finalTableNumber : '(éå…§ç”¨)');
            console.log('çµå¸³é è®€å–åˆ°çš„æ¡Œè™Ÿ (è¼¸å…¥æ¡†):', normalizedDomValue || '(ç„¡)');
            
            // ğŸ” èª¿è©¦ï¼šè¨˜éŒ„å®¢äººè¼¸å…¥çš„å‚™è¨»å…§å®¹
            console.log('å®¢äººè¼¸å…¥çš„å‚™è¨»å…§å®¹:', specialRequestValue);
            
            // æ›´æ–°è¨‚å–®æ•¸æ“šï¼ŒåŒ…å« specialRequest
            if (!orderData) {
                orderData = {};
            }
            orderData.specialRequest = specialRequestValue || null; // æ˜ç¢ºè¨­ç½® specialRequest
            orderData.tableNumber = expectsTableNumber ? (finalTableNumber || null) : null;
            orderData.diningMode = expectsTableNumber ? 'dine-in' : (sessionContext.diningMode || orderData.diningMode || 'takeout');

            // æª¢æŸ¥æ˜¯å¦ç‚ºå…§ç”¨è¨‚å–®
            const isDineIn = orderData.diningMode === 'dine-in';
            const url = isDineIn ? '/api/orders/dine-in' : '/api/orders/checkout';

            const basePayload = {
                specialRequest: specialRequestValue || null,
                tableNumber: finalTableNumber || null,
                diningMode: orderData.diningMode || (isDineIn ? 'dine-in' : 'takeout')
            };

            let payload;
            if (isDineIn) {
                payload = {
                    ...basePayload,
                    area: 'å…§ç”¨å€',
                    items: orderData.items,
                    total: orderData.totalAmount,
                    orderType: 'dine-in',
                    status: 'pending',
                    orderTime: new Date().toISOString()
                };
            } else {
                // âš ï¸ é—œéµä¿®å¾© 3ï¼šç¢ºä¿ requestData åŒ…å« specialRequest å­—æ®µ
                payload = {
                    ...orderData,
                    ...basePayload
                };
            }
            
            // ğŸ” èª¿è©¦ï¼šè¨˜éŒ„å‰ç«¯ç™¼é€çš„æ•¸æ“š
            console.log('[Debug] å‰ç«¯ç™¼é€çš„è¨‚å–®æ•¸æ“š:', JSON.stringify(payload, null, 2));
            console.log('[Debug] å‰ç«¯ç™¼é€çš„ specialRequest:', payload.specialRequest);
            console.log('é€å‡ºçš„ç‰¹æ®Šéœ€æ±‚:', payload.specialRequest);
            console.log('æº–å‚™é€å‡ºçš„æ¡Œè™Ÿ:', payload.tableNumber || '(æœªå¡«å¯«)');
                console.log('å‰ç«¯é€å‡ºçš„ Payload:', payload);
                console.log('ğŸš€ æœ€çµ‚é€å‡ºçš„çœŸå¯¦æ¡Œè™Ÿ:', payload.tableNumber || '(ç„¡)');
                console.log('ğŸš€ æœ€çµ‚é€å‡ºçš„ Payload:', payload);
            console.log('å‰ç«¯é€å‡ºçš„ Payload:', payload);
            console.log('ğŸš€ æœ€çµ‚é€å‡ºçš„çœŸå¯¦æ¡Œè™Ÿ:', payload.tableNumber || '(ç„¡)');
            console.log('ğŸš€ æœ€çµ‚é€å‡ºçš„ Payload:', payload);
            console.log('[Debug] ç¢ºèª specialRequest æ˜¯å¦æ­£ç¢ºåŒ…å«åœ¨ payload ä¸­:', payload.hasOwnProperty('specialRequest'));

            fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(payload)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // æ¸…é™¤å¾…è™•ç†è¨‚å–®
                    localStorage.removeItem('pendingOrder');
                    clearDiningContextStorage();
                    
                    // æ¸…ç©ºè³¼ç‰©è»Š
                    localStorage.removeItem('cart');
                    // å¦‚æœ window.cart å­˜åœ¨ï¼ˆåœ¨å…¶ä»–é é¢ï¼‰ï¼Œä¹Ÿæ¸…ç©ºå®ƒ
                    if (typeof window.cart !== 'undefined') {
                        window.cart = [];
                    }
                    console.log('âœ… è³¼ç‰©è»Šå·²æ¸…ç©º');
                    
                    alert('è¨‚å–®å·²æˆåŠŸæäº¤ï¼');
                    window.location.href = 'menu.html';
                } else {
                    alert(data.message || 'è¨‚å–®æäº¤å¤±æ•—ï¼Œè«‹é‡è©¦');
                    btn.disabled = false;
                    btn.textContent = 'å‰å¾€æ”¯ä»˜';
                }
            })
            .catch(error => {
                console.error('æäº¤è¨‚å–®å¤±æ•—:', error);
                alert('æäº¤è¨‚å–®æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹é‡è©¦');
                btn.disabled = false;
                btn.textContent = 'å‰å¾€æ”¯ä»˜';
            });
        }

        function goBack() {
            // æ¸…é™¤å¾…è™•ç†è¨‚å–®æ•¸æ“š
            localStorage.removeItem('pendingOrder');
            // è¿”å›èœå–®é é¢
            window.location.href = 'menu.html';
        }

        // é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            loadOrderData();
        });
    </script>
</body>
</html>

