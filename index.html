<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é£²èŒ¶è¶£ - æ¯ä¸€å£éƒ½æ˜¯å¹¸ç¦çš„æ»‹å‘³</title>
    <link rel="icon" type="image/webp" href="/images/sipandsavor.webp">
    <link rel="shortcut icon" type="image/webp" href="/images/sipandsavor.webp">
    <link rel="stylesheet" href="style-optimized.css">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        /* Logoæ¨£å¼ - èƒŒæ™¯åœ–ç‰‡æ–¹å¼ */
        .logo-link {
            position: fixed !important;
            top: 0px !important;
            left: -20px !important;
            width: 120px !important;
            height: 80px !important;
            z-index: 1000 !important;
            text-decoration: none !important;
            background-image: url('images/sipandsavor.webp') !important;
            background-size: contain !important;
            background-repeat: no-repeat !important;
            background-position: center !important;
            transition: opacity 0.3s ease !important;
            opacity: 0.9 !important;
        }
        
        .logo-link:hover {
            opacity: 1;
        }

        /* è³¼ç‰©è»Šåœ–æ¨™é–“è· - èˆ‡é£²æ–™èœå–®ä¿æŒä¸€è‡´ */
        .cart-icon {
            margin-left: 20px;
        }
    </style>
</head>
<body>
    <header>
        <!-- æ‰‹æ©Ÿå…ƒä»¶ -->
        <button class="menu" id="hamburgerBtn">&#9776;</button>
        
        <a href="index.html" class="logo-link" title="é£²èŒ¶è¶£"></a>
    
        <!-- æ¡Œé¢å°èˆª -->
        <nav class="desktop-nav">
            <ul>
                <li><a href="news.html">æœ€æ–°æ¶ˆæ¯</a></li>
                <li><a href="menu.html">é£²æ–™èœå–®</a></li>
                <li><a href="about.html">é—œæ–¼æˆ‘å€‘</a></li>
                <li><a href="stores.html">é–€å¸‚æ“šé»</a></li>
            </ul>
        </nav>
    
        <!-- è³¼ç‰©è»Šåœ–æ¨™ -->
        <div class="cart-icon" id="cartIcon">
            <span class="material-icons">shopping_cart</span>
            <span class="cart-count">0</span>
        </div>

        <!-- è³¼ç‰©è»Šå´é‚Šæ¬„ -->
        <div class="cart-sidebar" id="cartSidebar">
            <div class="cart-header">
                <h3>è³¼ç‰©è»Š</h3>
                <button class="close-cart" id="closeCart">&times;</button>
            </div>
            <div class="cart-items">
                <!-- è³¼ç‰©è»Šé …ç›®å°‡é€šé JavaScript å‹•æ…‹æ·»åŠ  -->
            </div>
            <div class="cart-footer">
                <div class="cart-total">
                    <span>ç¸½è¨ˆï¼š</span>
                    <span class="total-amount">NT$ 0</span>
                </div>
                <button class="checkout-btn">çµå¸³</button>
            </div>
        </div>
    
        <!-- æ‰‹æ©Ÿèœå–® -->
        <nav id="mobileMenu">
            <ul>
                <li><a href="news.html">æœ€æ–°æ¶ˆæ¯</a></li>
                <li><a href="menu.html">é£²æ–™èœå–®</a></li>
                <li><a href="about.html">é—œæ–¼æˆ‘å€‘</a></li>
                <li><a href="stores.html">é–€å¸‚æ“šé»</a></li>
            </ul>
        </nav>
    </header>
    
    <main>  
        <section class="news">   
                <h2>æ¯ä¸€å£éƒ½æ˜¯ä¸€å€‹æ•…äº‹</h2>
                <p>ã€Œç”¨å¿ƒæ³¡è£½ï¼Œè®“æ¯ä¸€å£éƒ½å€¼å¾—å“å‘³ã€‚ã€</p>
        </section>

        <!-- å…§ç”¨é»é¤å€åŸŸ -->
        <section class="dine-in-qr">
            <div class="qr-container">
                <h2>å…§ç”¨é»é¤</h2>
                <p>é»æ“Šä¸‹æ–¹QRç¢¼ï¼Œè¼¸å…¥æ¡Œè™Ÿå³å¯é»é¤</p>
                <div class="dine-in-button-container">
                    <div class="qr-code-container" id="qrContainer">
                        <img src="images/qrcode-new.webp" alt="å…§ç”¨é»é¤QRç¢¼" class="qr-code-image">
                        <div class="qr-overlay">
                            <span class="qr-text" id="qrText">æƒæQRç¢¼é»é¤</span>
                        </div>
                    </div>
                </div>
                <div class="qr-instructions">
                    <h3>ä½¿ç”¨æ­¥é©Ÿï¼š</h3>
                    <ol>
                        <li>é»æ“Šä¸Šæ–¹QRç¢¼</li>
                        <li>è¼¸å…¥æ‚¨çš„æ¡Œè™Ÿ</li>
                        <li>é¸æ“‡æƒ³è¦çš„é£²æ–™</li>
                        <li>é€å‡ºè¨‚å–®</li>
                    </ol>
                </div>
            </div>
        </section>

        <section class="slogan">
          <blockquote>"æ¯ä¸€å£<br>éƒ½æ˜¯å¹¸ç¦çš„æ»‹å‘³ã€‚"</blockquote>  
        </section>
        <section class="shop">
            <img src="images/å››å­£æ˜¥.webp" alt="å››å­£æ˜¥" loading="lazy">

                <div class="info">
                    <h2>ä¸€æ¯é£²å“ï¼Œç„¡é™å›å‘³</h2>
                    <p>å³æ—¥èµ·ä¾†åº—æ¶ˆè²»åŠ  LINE å¥½å‹å¯ç²å¾—ç²¾ç·»å°é»å¿ƒï¼Œç­‰æ‚¨ä¸€åŒåƒèˆ‡</p>
                </div>       
        </section>
    </main>
    <footer>
        <p>Copyright â— 2025 é£²èŒ¶è¶£ All Rights Reserved.</p>
        <!-- éš±è—çš„ç®¡ç†å…¥å£ -->
        <div class="hidden-admin-entry" id="hiddenAdminEntry">
            <div class="admin-entry-trigger" id="adminEntryTrigger">
                <span class="admin-hint">ğŸ‘‘</span>
            </div>
            <div class="admin-entry-modal" id="adminEntryModal">
                <div class="admin-entry-content">
                    <h3>ç®¡ç†å“¡å…¥å£</h3>
                    <p>ç¢ºèªé€²å…¥ç®¡ç†å¾Œå°ï¼Ÿ</p>
                    <div class="admin-entry-buttons">
                        <button id="adminLoginBtn">é€²å…¥å¾Œå°</button>
                        <button id="adminCancelBtn">å–æ¶ˆ</button>
                    </div>
                </div>
            </div>
        </div>
    </footer>

    <script src="script-enhanced.js"></script>
    <script>
        // ============================================
        // è¨‚å–®å®Œæˆè™•ç†é‚è¼¯ï¼ˆé¡ä¼¼ useEffectï¼‰
        // ============================================
        document.addEventListener('DOMContentLoaded', function() {
            // æª¢æŸ¥ URL åƒæ•¸
            const urlParams = new URLSearchParams(window.location.search);
            const status = urlParams.get('status');
            const orderNo = urlParams.get('orderNo');
            const amount = urlParams.get('amount');
            const message = urlParams.get('message');
            const orderType = urlParams.get('type');
            const pickupNumber = urlParams.get('pickupNumber');
            const tableNumber = urlParams.get('tableNumber');
            const paymentMethod = urlParams.get('method'); // âš ï¸ æ–°å¢ï¼šè®€å–ä»˜æ¬¾æ–¹å¼åƒæ•¸

            // å¦‚æœ status=successï¼ŒåŸ·è¡Œè¨‚å–®å®Œæˆé‚è¼¯
            if (status === 'success') {
                console.log('ğŸ‰ ä»˜æ¬¾æˆåŠŸï¼Œé–‹å§‹è™•ç†è¨‚å–®å®Œæˆé‚è¼¯...');
                handleOrderSuccess(orderNo, amount, orderType, pickupNumber, tableNumber, paymentMethod);
            } else if (status === 'failed' || status === 'error') {
                // è™•ç†å¤±æ•—æƒ…æ³
                console.log('âŒ ä»˜æ¬¾å¤±æ•—æˆ–ç™¼ç”ŸéŒ¯èª¤');
                handleOrderError(message);
            }

            // åŸæœ‰çš„ QR ç¢¼é‚è¼¯
            initQRCode();
        });

            /**
             * è™•ç†è¨‚å–®æˆåŠŸé‚è¼¯
             */
            function handleOrderSuccess(orderNo, amount, orderType, pickupNumberParam, tableNumberParam, paymentMethodParam) {
                try {
                    // åŸ·è¡Œå‹•ä½œ 1: æ¸…ç©ºè³¼ç‰©è»Š
                    console.log('ğŸ›’ æ¸…ç©ºè³¼ç‰©è»Š...');
                    clearCart();
        
                    const normalizedType = orderType === 'dinein' ? 'dinein' : 'takeout';
                    const isCashPayment = paymentMethodParam === 'cash'; // âš ï¸ åˆ¤æ–·æ˜¯å¦ç‚ºç¾é‡‘ä»˜æ¬¾
                    let successMessage = '';

                    // âš ï¸ é—œéµï¼šæ ¹æ“šä»˜æ¬¾æ–¹å¼é¡¯ç¤ºä¸åŒè¨Šæ¯
                    if (isCashPayment) {
                        // ç¾é‡‘ä»˜æ¬¾ï¼šé¡¯ç¤ºã€Œè«‹åˆ°æ«ƒå°çµå¸³ã€
                        if (normalizedType === 'takeout' && pickupNumberParam) {
                            successMessage = `è«‹åˆ°æ«ƒå°çµå¸³ æ‚¨çš„å–é¤è™Ÿç¢¼ï¼š${pickupNumberParam}`;
                        } else if (normalizedType === 'dinein' && tableNumberParam) {
                            successMessage = `è«‹åˆ°æ«ƒå°çµå¸³ é¤é»å°‡é€è‡³æ¡Œè™Ÿï¼š${tableNumberParam}`;
                        } else if (pickupNumberParam) {
                            successMessage = `è«‹åˆ°æ«ƒå°çµå¸³ æ‚¨çš„å–é¤è™Ÿç¢¼ï¼š${pickupNumberParam}`;
                        } else if (tableNumberParam) {
                            successMessage = `è«‹åˆ°æ«ƒå°çµå¸³ é¤é»å°‡é€è‡³æ¡Œè™Ÿï¼š${tableNumberParam}`;
                        } else {
                            successMessage = 'è«‹åˆ°æ«ƒå°çµå¸³';
                        }
                    } else {
                        // åˆ·å¡ä»˜æ¬¾ï¼ˆæˆ–é è¨­ï¼‰ï¼šé¡¯ç¤ºã€Œä»˜æ¬¾æˆåŠŸã€
                        if (normalizedType === 'takeout' && pickupNumberParam) {
                            successMessage = `ä»˜æ¬¾æˆåŠŸï¼æ‚¨çš„å–é¤è™Ÿç¢¼ï¼š${pickupNumberParam}`;
                        } else if (normalizedType === 'dinein' && tableNumberParam) {
                            successMessage = `ä»˜æ¬¾æˆåŠŸï¼é¤é»å°‡é€è‡³æ¡Œè™Ÿï¼š${tableNumberParam}`;
                        } else if (pickupNumberParam) {
                            successMessage = `ä»˜æ¬¾æˆåŠŸï¼æ‚¨çš„å–é¤è™Ÿç¢¼ï¼š${pickupNumberParam}`;
                        } else if (tableNumberParam) {
                            successMessage = `ä»˜æ¬¾æˆåŠŸï¼é¤é»å°‡é€è‡³æ¡Œè™Ÿï¼š${tableNumberParam}`;
                        } else {
                            successMessage = 'ä»˜æ¬¾æˆåŠŸï¼';
                        }
                    }

                    if (normalizedType === 'takeout') {
                        console.log('ğŸ¥¤ å¤–å¸¶è¨‚å–®ï¼Œå–é¤è™Ÿ:', pickupNumberParam || '(ç„¡)');
                    } else {
                        console.log('ğŸ½ï¸ å…§ç”¨è¨‚å–®ï¼Œæ¡Œè™Ÿ:', tableNumberParam || '(ç„¡)');
                    }

                    showSuccessModal(
                        successMessage,
                        orderNo,
                        amount,
                        normalizedType === 'takeout' ? pickupNumberParam : null,
                        normalizedType === 'dinein' ? tableNumberParam : null
                    );
        
                    // åŸ·è¡Œå‹•ä½œ 3: æ¸…ç† URL åƒæ•¸å’Œ localStorage
                    cleanupAfterOrder();
                } catch (error) {
                    console.error('âŒ è™•ç†è¨‚å–®æˆåŠŸæ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                    alert('è™•ç†è¨‚å–®æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹è¯ç¹«å®¢æœ');
                }
            }

        /**
         * è™•ç†è¨‚å–®éŒ¯èª¤
         */
        function handleOrderError(message) {
            const errorMsg = message ? decodeURIComponent(message) : 'äº¤æ˜“æœªèƒ½å®Œæˆï¼Œè«‹ç¨å¾Œå†è©¦ã€‚';
            alert(errorMsg);
            // æ¸…ç† URL åƒæ•¸
            cleanupAfterOrder();
        }

        /**
         * æ¸…ç©ºè³¼ç‰©è»Š
         */
        function clearCart() {
            try {
                // æ¸…é™¤ localStorage ä¸­çš„è³¼ç‰©è»Š
                localStorage.removeItem('cart');
                localStorage.removeItem('pendingOrder');
                
                // æ¸…é™¤å…¨å±€è®Šé‡ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                if (typeof window.cart !== 'undefined') {
                    window.cart = [];
                }
                
                // æ›´æ–°è³¼ç‰©è»Šé¡¯ç¤ºï¼ˆå¦‚æœè³¼ç‰©è»ŠåŠŸèƒ½å·²åˆå§‹åŒ–ï¼‰
                if (typeof updateCartDisplay === 'function') {
                    updateCartDisplay();
                }
                
                console.log('âœ… è³¼ç‰©è»Šå·²æ¸…é™¤');
            } catch (error) {
                console.error('âŒ æ¸…é™¤è³¼ç‰©è»Šå¤±æ•—:', error);
                throw error;
            }
        }


        /**
         * é¡¯ç¤ºæˆåŠŸè¦–çª—
         */
        function showSuccessModal(message, orderNo, amount, pickupCode, dineInTable) {
            // å‰µå»º Modal å…ƒç´ 
            const modal = document.createElement('div');
            modal.className = 'order-success-modal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 10000;
                animation: fadeIn 0.3s ease;
            `;

            const modalContent = document.createElement('div');
            modalContent.style.cssText = `
                background: white;
                padding: 40px;
                border-radius: 15px;
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
                text-align: center;
                max-width: 400px;
                width: 90%;
                animation: slideUp 0.3s ease;
            `;

            let html = `
                <div style="font-size: 60px; color: #2ed573; margin-bottom: 20px;">
                    <span class="material-icons" style="font-size: 60px;">check_circle</span>
                </div>
                <h2 style="color: #2c3e50; margin-bottom: 15px; font-size: 24px;">${message}</h2>
            `;

            if (orderNo) {
                html += `<p style="color: #666; margin: 10px 0; font-size: 14px;">è¨‚å–®ç·¨è™Ÿï¼š${orderNo}</p>`;
            }

            if (amount) {
                html += `<p style="color: #666; margin: 10px 0; font-size: 14px;">æ”¯ä»˜é‡‘é¡ï¼šNT$ ${parseInt(amount).toLocaleString()}</p>`;
            }

            if (pickupCode) {
                html += `
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin: 20px 0;">
                        <p style="color: #2c3e50; font-size: 16px; margin-bottom: 10px;">å–é¤è™Ÿç¢¼</p>
                        <p style="color: #2ed573; font-size: 48px; font-weight: bold; letter-spacing: 5px;">${pickupCode}</p>
                    </div>
                `;
            } else if (dineInTable) {
                html += `
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin: 20px 0;">
                        <p style="color: #2c3e50; font-size: 16px; margin-bottom: 10px;">å…§ç”¨æ¡Œè™Ÿ</p>
                        <p style="color: #2ed573; font-size: 36px; font-weight: bold; letter-spacing: 3px;">${dineInTable}</p>
                    </div>
                `;
            }

            html += `
                <button id="closeSuccessModal" style="
                    background: #2ed573;
                    color: white;
                    border: none;
                    padding: 12px 30px;
                    border-radius: 8px;
                    font-size: 16px;
                    cursor: pointer;
                    margin-top: 20px;
                    transition: all 0.3s;
                ">ç¢ºå®š</button>
            `;

            modalContent.innerHTML = html;
            modal.appendChild(modalContent);
            document.body.appendChild(modal);

            // æ·»åŠ å‹•ç•«æ¨£å¼
            const style = document.createElement('style');
            style.textContent = `
                @keyframes fadeIn {
                    from { opacity: 0; }
                    to { opacity: 1; }
                }
                @keyframes slideUp {
                    from {
                        transform: translateY(20px);
                        opacity: 0;
                    }
                    to {
                        transform: translateY(0);
                        opacity: 1;
                    }
                }
                .order-success-modal button:hover {
                    background: #26c463;
                }
            `;
            document.head.appendChild(style);

            // é—œé–‰æŒ‰éˆ•äº‹ä»¶
            document.getElementById('closeSuccessModal').addEventListener('click', function() {
                modal.style.animation = 'fadeIn 0.3s ease reverse';
                setTimeout(() => {
                    modal.remove();
                    style.remove();
                }, 300);
            });

            // é»æ“ŠèƒŒæ™¯é—œé–‰
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    document.getElementById('closeSuccessModal').click();
                }
            });
        }

        /**
         * æ¸…ç† URL åƒæ•¸å’Œ localStorage
         */
        function cleanupAfterOrder() {
            try {
                // ä½¿ç”¨ window.history.replaceState æ¸…é™¤ç¶²å€ä¸Šçš„åƒæ•¸
                const cleanUrl = window.location.pathname;
                window.history.replaceState({}, document.title, cleanUrl);
                console.log('âœ… URL åƒæ•¸å·²æ¸…é™¤');

                // æ¸…é™¤ localStorage çš„ diningMode ç›¸é—œè³‡æ–™
                localStorage.removeItem('dineInTableNumber');
                localStorage.removeItem('diningMode');
                console.log('âœ… localStorage å·²æ¸…ç†');
            } catch (error) {
                console.error('âŒ æ¸…ç†æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
            }
        }

        /**
         * åˆå§‹åŒ– QR ç¢¼é‚è¼¯
         */
        function initQRCode() {
            const qrContainer = document.getElementById('qrContainer');
            const qrText = document.getElementById('qrText');
            
            if (!qrContainer || !qrText) return;

            // æª¢æ¸¬æ˜¯å¦ç‚ºç§»å‹•è¨­å‚™
            function isMobileDevice() {
                return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ||
                       window.innerWidth <= 768;
            }
            
            if (isMobileDevice()) {
                // æ‰‹æ©Ÿç«¯ï¼šé¡¯ç¤ºæƒææç¤ºï¼Œä¸æ·»åŠ é»æ“Šäº‹ä»¶
                qrText.textContent = 'æƒæQRç¢¼é»é¤';
                qrContainer.style.cursor = 'default';
            } else {
                // é›»è…¦ç«¯ï¼šæ·»åŠ é»æ“Šäº‹ä»¶ï¼Œè·³è½‰åˆ°é»é¤é é¢
                qrText.textContent = 'é»æ“Šé€²å…¥é»é¤';
                qrContainer.style.cursor = 'pointer';
                qrContainer.addEventListener('click', function() {
                    const currentUrl = window.location.origin;
                    const orderUrl = `${currentUrl}/dine-in-order.html`;
                    window.location.href = orderUrl;
                });
                
                // æ·»åŠ æ‡¸åœæ•ˆæœ
                qrContainer.addEventListener('mouseenter', function() {
                    this.style.transform = 'scale(1.05)';
                });
                
                qrContainer.addEventListener('mouseleave', function() {
                    this.style.transform = 'scale(1)';
                });
            }
        }
    </script>

</body>
</html>