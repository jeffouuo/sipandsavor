<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åº«å­˜åŒæ­¥æ¸¬è©¦ - é£²èŒ¶è¶£</title>
    <link rel="icon" type="image/webp" href="/images/sipandsavor.webp">
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        
        .test-section h3 {
            margin-top: 0;
            color: #4CAF50;
        }
        
        .btn {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
        }
        
        .btn:hover {
            background: #45a049;
        }
        
        .btn-secondary {
            background: #6c757d;
        }
        
        .btn-secondary:hover {
            background: #5a6268;
        }
        
        .status {
            margin-top: 10px;
            padding: 10px;
            border-radius: 4px;
            font-weight: bold;
        }
        
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            margin-top: 15px;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        
        .log-entry {
            margin-bottom: 5px;
            padding: 2px 0;
        }
        
        .log-entry.success {
            color: #28a745;
        }
        
        .log-entry.error {
            color: #dc3545;
        }
        
        .log-entry.info {
            color: #17a2b8;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        .form-group input, .form-group select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“¦ åº«å­˜åŒæ­¥åŠŸèƒ½æ¸¬è©¦</h1>
        
        <div class="test-section">
            <h3>ğŸ”— SSE é€£æ¥æ¸¬è©¦</h3>
            <button class="btn" onclick="testSSEConnection()">æ¸¬è©¦ SSE é€£æ¥</button>
            <button class="btn btn-secondary" onclick="disconnectSSE()">æ–·é–‹ SSE é€£æ¥</button>
            <div id="sseStatus" class="status info">ç­‰å¾…æ¸¬è©¦...</div>
        </div>
        
        <div class="test-section">
            <h3>ğŸ›’ æ¨¡æ“¬ä¸‹å–®æ¸¬è©¦</h3>
            <div class="form-group">
                <label>é¸æ“‡å•†å“:</label>
                <select id="productSelect">
                    <option value="">è«‹é¸æ“‡å•†å“</option>
                </select>
            </div>
            <div class="form-group">
                <label>æ•¸é‡:</label>
                <input type="number" id="quantityInput" value="1" min="1" max="10">
            </div>
            <button class="btn" onclick="simulateOrder()">æ¨¡æ“¬ä¸‹å–®</button>
            <div id="orderStatus" class="status info">ç­‰å¾…æ¸¬è©¦...</div>
        </div>
        
        <div class="test-section">
            <h3>ğŸ“Š åº«å­˜è®Šæ›´è¨˜éŒ„</h3>
            <button class="btn btn-secondary" onclick="clearLog()">æ¸…é™¤è¨˜éŒ„</button>
            <div id="stockLog" class="log">
                <div class="log-entry info">ç­‰å¾…åº«å­˜è®Šæ›´...</div>
            </div>
        </div>
        
        <div class="test-section">
            <h3>ğŸ”§ å¾Œå°ç®¡ç†æ¸¬è©¦</h3>
            <button class="btn" onclick="openAdmin()">æ‰“é–‹å¾Œå°ç®¡ç†</button>
            <button class="btn btn-secondary" onclick="testManualStockUpdate()">æ¨¡æ“¬æ‰‹å‹•æ›´æ–°åº«å­˜</button>
            <div id="adminStatus" class="status info">ç­‰å¾…æ¸¬è©¦...</div>
        </div>
    </div>

    <script>
        // æ¸¬è©¦é…ç½®
        const API_BASE_URL = window.location.hostname.includes('localhost') 
            ? `http://localhost:${window.location.port || '3001'}/api`
            : '/api';
        
        let sseConnection = null;
        let products = [];
        
        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸš€ åº«å­˜åŒæ­¥æ¸¬è©¦é é¢åˆå§‹åŒ–');
            loadProducts();
        });
        
        // è¼‰å…¥å•†å“åˆ—è¡¨
        async function loadProducts() {
            try {
                const response = await fetch(`${API_BASE_URL}/products`);
                const data = await response.json();
                
                if (data.success) {
                    products = data.data.products;
                    const select = document.getElementById('productSelect');
                    
                    products.forEach(product => {
                        const option = document.createElement('option');
                        option.value = product._id;
                        option.textContent = `${product.name} (åº«å­˜: ${product.stock})`;
                        select.appendChild(option);
                    });
                    
                    log('å•†å“åˆ—è¡¨è¼‰å…¥æˆåŠŸ', 'success');
                } else {
                    log('å•†å“åˆ—è¡¨è¼‰å…¥å¤±æ•—: ' + data.message, 'error');
                }
            } catch (error) {
                log('å•†å“åˆ—è¡¨è¼‰å…¥éŒ¯èª¤: ' + error.message, 'error');
            }
        }
        
        // æ¸¬è©¦ SSE é€£æ¥
        function testSSEConnection() {
            const statusDiv = document.getElementById('sseStatus');
            statusDiv.className = 'status info';
            statusDiv.textContent = 'æ­£åœ¨å»ºç«‹ SSE é€£æ¥...';
            
            try {
                if (sseConnection) {
                    sseConnection.close();
                }
                
                sseConnection = new EventSource(`${API_BASE_URL}/sse`);
                
                sseConnection.onopen = function(event) {
                    statusDiv.className = 'status success';
                    statusDiv.textContent = 'âœ… SSE é€£æ¥å·²å»ºç«‹';
                    log('SSE é€£æ¥å·²å»ºç«‹', 'success');
                };
                
                sseConnection.onmessage = function(event) {
                    try {
                        const data = JSON.parse(event.data);
                        log('æ”¶åˆ° SSE æ¶ˆæ¯: ' + JSON.stringify(data), 'info');
                        
                        if (data.type === 'stock_change') {
                            log(`ğŸ“¦ åº«å­˜è®Šæ›´: ${data.productName} ${data.oldStock} â†’ ${data.newStock}`, 'success');
                        }
                    } catch (error) {
                        log('SSE æ¶ˆæ¯è§£æå¤±æ•—: ' + error.message, 'error');
                    }
                };
                
                sseConnection.onerror = function(event) {
                    statusDiv.className = 'status error';
                    statusDiv.textContent = 'âŒ SSE é€£æ¥éŒ¯èª¤';
                    log('SSE é€£æ¥éŒ¯èª¤', 'error');
                };
                
            } catch (error) {
                statusDiv.className = 'status error';
                statusDiv.textContent = 'âŒ SSE é€£æ¥å»ºç«‹å¤±æ•—: ' + error.message;
                log('SSE é€£æ¥å»ºç«‹å¤±æ•—: ' + error.message, 'error');
            }
        }
        
        // æ–·é–‹ SSE é€£æ¥
        function disconnectSSE() {
            if (sseConnection) {
                sseConnection.close();
                sseConnection = null;
                
                const statusDiv = document.getElementById('sseStatus');
                statusDiv.className = 'status info';
                statusDiv.textContent = 'SSE é€£æ¥å·²æ–·é–‹';
                
                log('SSE é€£æ¥å·²æ–·é–‹', 'info');
            }
        }
        
        // æ¨¡æ“¬ä¸‹å–®
        async function simulateOrder() {
            const productId = document.getElementById('productSelect').value;
            const quantity = parseInt(document.getElementById('quantityInput').value);
            
            if (!productId) {
                alert('è«‹é¸æ“‡å•†å“');
                return;
            }
            
            const product = products.find(p => p._id === productId);
            if (!product) {
                alert('å•†å“ä¸å­˜åœ¨');
                return;
            }
            
            const statusDiv = document.getElementById('orderStatus');
            statusDiv.className = 'status info';
            statusDiv.textContent = 'æ­£åœ¨æ¨¡æ“¬ä¸‹å–®...';
            
            try {
                const orderData = {
                    items: [{
                        name: product.name,
                        price: product.price,
                        quantity: quantity
                    }],
                    totalAmount: product.price * quantity,
                    paymentMethod: 'cash',
                    deliveryMethod: 'pickup',
                    notes: 'åº«å­˜åŒæ­¥æ¸¬è©¦è¨‚å–®'
                };
                
                const response = await fetch(`${API_BASE_URL}/orders/checkout`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(orderData)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    statusDiv.className = 'status success';
                    statusDiv.textContent = 'âœ… ä¸‹å–®æˆåŠŸï¼è¨‚å–®ID: ' + data.data.order._id;
                    log(`ä¸‹å–®æˆåŠŸ: ${product.name} x${quantity}`, 'success');
                    
                    // æ›´æ–°å•†å“åˆ—è¡¨
                    setTimeout(loadProducts, 1000);
                } else {
                    statusDiv.className = 'status error';
                    statusDiv.textContent = 'âŒ ä¸‹å–®å¤±æ•—: ' + data.message;
                    log('ä¸‹å–®å¤±æ•—: ' + data.message, 'error');
                }
            } catch (error) {
                statusDiv.className = 'status error';
                statusDiv.textContent = 'âŒ ä¸‹å–®éŒ¯èª¤: ' + error.message;
                log('ä¸‹å–®éŒ¯èª¤: ' + error.message, 'error');
            }
        }
        
        // æ¨¡æ“¬æ‰‹å‹•æ›´æ–°åº«å­˜
        async function testManualStockUpdate() {
            const productId = document.getElementById('productSelect').value;
            
            if (!productId) {
                alert('è«‹é¸æ“‡å•†å“');
                return;
            }
            
            const newStock = prompt('è«‹è¼¸å…¥æ–°çš„åº«å­˜æ•¸é‡:');
            if (newStock === null) return;
            
            const stock = parseInt(newStock);
            if (isNaN(stock) || stock < 0) {
                alert('è«‹è¼¸å…¥æœ‰æ•ˆçš„åº«å­˜æ•¸é‡');
                return;
            }
            
            const statusDiv = document.getElementById('adminStatus');
            statusDiv.className = 'status info';
            statusDiv.textContent = 'æ­£åœ¨æ›´æ–°åº«å­˜...';
            
            try {
                const response = await fetch(`${API_BASE_URL}/products/${productId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + localStorage.getItem('adminToken')
                    },
                    body: JSON.stringify({ stock: stock })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    statusDiv.className = 'status success';
                    statusDiv.textContent = 'âœ… åº«å­˜æ›´æ–°æˆåŠŸï¼';
                    log(`æ‰‹å‹•æ›´æ–°åº«å­˜æˆåŠŸ: ${stock}`, 'success');
                    
                    // æ›´æ–°å•†å“åˆ—è¡¨
                    setTimeout(loadProducts, 1000);
                } else {
                    statusDiv.className = 'status error';
                    statusDiv.textContent = 'âŒ åº«å­˜æ›´æ–°å¤±æ•—: ' + data.message;
                    log('åº«å­˜æ›´æ–°å¤±æ•—: ' + data.message, 'error');
                }
            } catch (error) {
                statusDiv.className = 'status error';
                statusDiv.textContent = 'âŒ åº«å­˜æ›´æ–°éŒ¯èª¤: ' + error.message;
                log('åº«å­˜æ›´æ–°éŒ¯èª¤: ' + error.message, 'error');
            }
        }
        
        // æ‰“é–‹å¾Œå°ç®¡ç†
        function openAdmin() {
            window.open('admin.html', '_blank');
        }
        
        // æ¸…é™¤è¨˜éŒ„
        function clearLog() {
            const logDiv = document.getElementById('stockLog');
            logDiv.innerHTML = '<div class="log-entry info">è¨˜éŒ„å·²æ¸…é™¤...</div>';
        }
        
        // è¨˜éŒ„æ—¥èªŒ
        function log(message, type = 'info') {
            const logDiv = document.getElementById('stockLog');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logDiv.appendChild(entry);
            
            // è‡ªå‹•æ»¾å‹•åˆ°åº•éƒ¨
            logDiv.scrollTop = logDiv.scrollHeight;
        }
    </script>
</body>
</html>
